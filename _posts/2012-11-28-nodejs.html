---
layout: post
title: node.js 분석
date: '2012-11-28T14:32:00.002+09:00'
author: jeremyko
tags:
- javascript
- node.js
modified_time: '2021-03-24T22:30:27.858+09:00'
blogger_id: tag:blogger.com,1999:blog-7360229670252766698.post-4436209613754099665
blogger_orig_url: https://jeremyko.blogspot.com/2012/11/nodejs.html
---

<br /><h1 class="firstHeading" id="firstHeading" lang="en" style="background-image: none; border-bottom-color: rgb(170, 170, 170); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(170, 170, 170); font-family: sans-serif; font-size: 1.6em; font-weight: normal; line-height: 1.2em; margin: 0px 0px 0.1em; overflow: hidden; padding-bottom: 0px; padding-top: 0px;"><span dir="auto">Node.js source code analysis</span></h1><div><b>How node executes user code ?</b></div><div><br /></div><div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;"><div style="box-sizing: border-box; color: #222222; font-family: &quot;Open Sans&quot;, HelveticaNeue, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 18px; line-height: 28.9px; margin-bottom: 2.5rem;">최근 국내에도 node.js 컨퍼런스가 개최되는등 관심이 높아지고 있다. 그런데 기존 javascript를 어떻게 웹브라우져에 독립적으로 만들었고, 서버 사이드에서도 활용가능한 여러 기능들을 어떤식으로 추가했는지, 그 내부 사항을 node.js의 소스 코드를 따라가면서 간략히 알아보자.</div><div style="box-sizing: border-box; color: #222222; font-family: &quot;Open Sans&quot;, HelveticaNeue, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 18px; line-height: 28.9px; margin-bottom: 2.5rem;">(2014.11.09 일 node.js github에 올려진 소스 코드를 기준으로 작성됨)</div></div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px;"><br /></div><h1 id="nodejs-" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin-bottom: 16px; margin-left: 0px; margin-right: 0px; margin-top: 0px !important; margin: 0px 0px 16px; padding-bottom: 0.3em; position: relative;">Node.js 맛보기</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">node.js 는 기존의 자바스크립트 문법을 사용해서, 웹 브라우져로부터 독립적인 환경에서, 비동기 처리의 장점을 활용하여 서버 사이드에서 요구되는 여러 기능을 구현할수 있게끔 구현 되었다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">먼저 간단한 예제를 보자.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;"><br /></span></code></pre><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> fs = <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span>(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'fs'</span>);<br />fs.readFile(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'./bigFile.txt'</span>, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'utf8'</span>, <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(err, data)</span> </span>{<br />  <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">console</span>.log(data);<br />});<br /><span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">console</span>.log(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'exiting...'</span>);<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;"><br />파일을 비동기로 읽는 예제이다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">사용자가 작성한 javascript (이하 js) 에서는 file system 기능을 가지고 있는 fs 객체를 require ('fs') 함수로 요청하여 얻고, 그 객체의 readFile() 함수를 이용하고 있다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">이 파일을 fsTest.js 로 저장하고, 다음처럼 실행하면,</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">$ cp /usr/share/dict/words bigFile.txt --&gt; 이것은 큰 사이즈의 파일을 만들기 위한 작업<br />$ node ./fsTest.js<br />exiting...<br />A<br />a<br />aa<br />......<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">'exiting' 문자열이 바로 출력되고 이후, 파일에 대한 비동기 읽기 작업이 완료될때 나머지 결과가 출력되는것을 볼수 있다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">이 예제에서 보이는 require 나 readFile 식별자들은 자바스크립트가 기본적으로 제공하는것이 아니라는 점을 유의하기 바란다. 위의 예제를 크롬 웹브라우져의 자바콘솔에서 돌려 본다면 다음과 같은 에러를 만나게 될것이다.</div><blockquote style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-left-color: rgb(221, 221, 221); border-left-style: solid; border-left-width: 4px; border-left: 4px solid rgb(221, 221, 221); box-sizing: border-box; color: #777777; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 0px !important; margin-left: 0px; margin-right: 0px; margin-top: 0px; margin: 0px; padding: 0px 15px;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">ReferenceError: require is not defined</div></blockquote><br /><a name='more'></a><br /><br /><h1 id="nodejs-" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin-bottom: 16px; margin-left: 0px; margin-right: 0px; margin-top: 0px !important; margin: 0px 0px 16px; padding-bottom: 0.3em; position: relative;">Node.js 구성요소</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">이 예제를 실행한것을 살펴보면, 실행 파일 node의 인자로서 js를 전달했다.<br />사용자가 작성한 자바스크립트 코드를 node 라는 프로그램을 이용해서 구동시키고 있는것이다.&nbsp; 이처럼 node 실행 파일은 내부적으로 javascript를 분석하여 네이티브한 머신코드로 변환해준다.&nbsp; 이것이 바로 웹브라우져에 독립적인 javascript 실행을 가능하게 해주는 핵심이다.<br />node.js는 javascript engine으로 Google의 V8을 사용한다.</div><h1 id="v8" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin: 1em 0px 16px; padding-bottom: 0.3em; position: relative;">V8</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">V8 은 c++ API를 제공하는데, 이를 통해서 자신의 c++ 소스내에 V8 JavaScript engine을 내장시킬수가 있고, 자바스크립트 코드를 실행하고 결과를 얻을수 있다. 또한 자신이 작성한 C++소스를 js에서도 접근할수 있다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">node.js에서는 이것을 활용하여, c++로 node 의 core 기능들을 구현한 후<br />(이를 node.js내에서는 builtin module 이라고 표현하고 있다),<br />V8 c++ api를 이용해서 javascript에서도 인식할수 있게끔 하였다.<br />그리고 이 c++ 에서 작성된 기능을 사용하는 native javascript 들을 작성하였다(이를 node에서는 native module 이라고 부른다).<br />사용자의 자바스크립트에서 이 기능들을 불러와서 사용할수 있게끔 CommonJS 규격에 의한 모듈 시스템도 작성하였다 (위 예제에서 보이는 require 를 말한다).</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">즉, node.js의 소스코드는 c++로된 부분과 javascript로 구현된 부분으로 구분되고,<br />javascript소스에서는 c++ 소스의 기능을 가져다가 사용하는 구조로 되어있다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">최초에 V8를 활용해서 node.js같은 프레임워크를 만들려고 한 발상이, 독특하고 뛰어난 것이었다고 할수 있겠다.</div><h1 id="nativebuiltin-module" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin: 1em 0px 16px; padding-bottom: 0.3em; position: relative;">native/builtin module</h1><ul style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;"><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">native module : node에서 제공하는 js 모듈을 말한다.</li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">builtin module : javascript 만으로는 구현할수 없는 기능 위한 C++ 모듈을 의미.</li></ul><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">native module 에서 c++ builtin module의 기능을 사용해서 원하는 기능을 수행한다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">예)</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">//lib/os.js<br />var binding = process.binding('os');<br />//c++ builtin module 'os'의 기능을 가져와서 js native module 의 기능을 구현한다.<br /></code></pre><h1 id="commonjs" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin: 1em 0px 16px; padding-bottom: 0.3em; position: relative;">CommonJS</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;"><a href="http://www.commonjs.org/" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-attachment: initial; background-clip: initial; background-image: initial; background-origin: initial; background-position: initial; background-repeat: initial; background-size: initial; box-sizing: border-box; color: #4183c4; text-decoration: none;" target="_blank">CommonJS</a>&nbsp;는 브라우져 기반의 js를 탈피하고 좀더 광범위한 js 어플리케이션을 개발하는데 있어 필수적인 요소들, 즉 Python, Ruby, Java등에서 제공되는 수준의 풍부한 표준 라이브러리 제공을 위한 API 규격을 정의하고 있는데, 사이트에 가보면 require 함수, exports 객체에 대해 정의하고 다음처럼 사용되길 원한다(즉 specification 이다).</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//math.js --&gt; exports 객체(이 스크립트에 주어지는 객체로 구현은 알아서)에 원하는 기능을 추가.</span><br />exports.add = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">()</span> </span>{<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> sum = <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">0</span>, i = <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">0</span>, args = <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">arguments</span>, l = args.length;<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">while</span> (i &lt; l) {<br />        sum += args[i++];<br />    }<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> sum;<br />};<br /></code></pre><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//increment.js</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> add = <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span>(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'math'</span>).add; <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// require를 통해서 원하는 기능을 가진 객체를 얻음.</span><br />exports.increment = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(val)</span> </span>{<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> add(val, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span>);<br />};<br /></code></pre><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//program.js</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> inc = <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span>(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'increment'</span>).increment; <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//마찬가지..</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> a = <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span>;<br />inc(a); <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// 2</span><br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">node.js에서도 이러한 commonJS를 따르고, 그 spec대로 구현했기에, 위에서처럼 사용할수 있다.&nbsp; exports, require가 어떻게 구현되는지는 뒷부분에서 설명된다.</div><h1 id="libuv" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin: 1em 0px 16px; padding-bottom: 0.3em; position: relative;">libuv</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px;">또 하나 node.js 의 중심을 이루는것은 비동기 처리를 실제로 담당하고 있는 libuv 라이브러리이다.&nbsp; 이것은 윈도우즈의 IOCP 와 Unix 의 epoll/kqueue/event ports/등의 기능을 추상화 시켜 플랫폼 독립적으로 비동기 작업 수행을 가능하게 한다.&nbsp; 내부적으로는 thread pool 을 구현하고 있다. <span face="'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif" style="color: #333333; font-size: 16px; line-height: 25.6px;">node.js의 비동기처리는 libuv 라이브로리 호출로서 구현된다.</span><br /></div><br /><h1 id="js--c" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin-bottom: 16px; margin-left: 0px; margin-right: 0px; margin-top: 0px !important; margin: 0px 0px 16px; padding-bottom: 0.3em; position: relative;">js 와 c++</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">먼저 node.js 프로젝트의 디렉토리 구조를 간단히 살펴보자.</div><ul style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 0px; margin-top: 0px; padding: 0px 0px 0px 2em;"><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">src 폴더에는 network, file system등, 기존 javascript 만으로는 구현 불가능한 영역에 위한 c++ 구현 소스가 존재한다.</li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">lib 폴더에는 이러한 c++ 코드의 기능들을 가져와서 사용하는, javascript 로 구현된 소스가 존재한다(native modules).</li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">deps 폴더안에는 node 를 구성하는데 필요한 의존 소스들, 즉, v8, uv등의 소스가 존재한다.</li></ul><div><span face="Open Sans, Clear Sans, Helvetica Neue, Helvetica, Arial, sans-serif" style="color: #333333;"><span style="line-height: 25.6px;"><br /></span></span></div><div><h1 id="macro-node_module_struct" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin-bottom: 16px; margin-left: 0px; margin-right: 0px; margin-top: 0px !important; margin: 0px 0px 16px; padding-bottom: 0.3em; position: relative;">macro들과 node_module_struct</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">src 폴더의 c++ 소스 내부에는 c++의 함수를 js에서 사용하게 하기 위한 부분들이 포함되어 있다.&nbsp;&nbsp; 예를 들어서 node_os.cc 소스를 한번 살펴보자. 마지막 부분에 다음과 같은 부분을 발견할수 있다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//.... 각종 기능 구현 ....</span><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span> Initialize(Handle&lt;Object&gt; target,<br />                Handle&lt;Value&gt; unused,<br />                Handle&lt;Context&gt; context) {<br />  NODE_SET_METHOD(target, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"getEndianness"</span>, GetEndianness);<br />  NODE_SET_METHOD(target, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"getHostname"</span>, GetHostname);<br />  NODE_SET_METHOD(target, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"getLoadAvg"</span>, GetLoadAvg);<br />  NODE_SET_METHOD(target, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"getUptime"</span>, GetUptime);<br />  NODE_SET_METHOD(target, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"getTotalMem"</span>, GetTotalMemory);<br />  NODE_SET_METHOD(target, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"getFreeMem"</span>, GetFreeMemory);<br />  NODE_SET_METHOD(target, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"getCPUs"</span>, GetCPUInfo);<br />  NODE_SET_METHOD(target, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"getOSType"</span>, GetOSType);<br />  NODE_SET_METHOD(target, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"getOSRelease"</span>, GetOSRelease);<br />  NODE_SET_METHOD(target, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"getInterfaceAddresses"</span>, GetInterfaceAddresses);<br />}<br /><br />}  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// namespace os</span><br />}  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// namespace node</span><br /><br />NODE_MODULE_CONTEXT_AWARE_BUILTIN(os, node::os::Initialize)<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">먼저 NODE_SET_METHOD 의 정의 부분을 찾아보면,</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-preprocessor" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">#<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">define</span> NODE_SET_METHOD node::NODE_SET_METHOD</span><br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">으로, 다음 함수를 호출하게 된다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">template</span> &lt;<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">typename</span> TypeName&gt;<br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">inline</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span> NODE_SET_METHOD(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> TypeName&amp; recv,<br />                            <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span>* name,<br />                            v8::FunctionCallback callback) {<br />  v8::Isolate* isolate = v8::Isolate::GetCurrent();<br />  v8::HandleScope handle_scope(isolate);<br />  v8::Local&lt;v8::FunctionTemplate&gt; t = v8::FunctionTemplate::New(isolate,<br />                                                                callback);<br />  v8::Local&lt;v8::Function&gt; fn = t-&gt;GetFunction();<br />  v8::Local&lt;v8::String&gt; fn_name = v8::String::NewFromUtf8(isolate, name);<br />  fn-&gt;SetName(fn_name);<br />  recv-&gt;Set(fn_name, fn);<br />}<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">V8 가 제공하는 API를 호출하는것인데, C++ 함수를 javascript 에서 접근할수 있게 해주는 부분이다 (위 코드의 의미를 좀 더 자세히 알고 싶다면 V8문서를 참고하기 바란다).</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px;">그런데 여기서 recv는 무엇을 나타내는가?<br />위 코드를 보면 Handle&nbsp;target 을 전달한것이다.<br />그것은 v8 에서의 JavaScript object 를 의미한다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;"></div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">즉 위 함수는 전달된 자바스크립트 객체에 fn_name 을 key로, 그 value는 함수를 저장한다.<br />실제 이 함수를 이용하려면 전달된 자바스크립트 객체를 통해서 호출해야 할것이다.<br />javascript 에서 이 자바스크립트 객체를 통해서 getCPUs() 함수를 호출하면,<br />c++ 함수인 GetCPUInfo() 가 불려지게 된다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">그럼 NODE_MODULE_CONTEXT_AWARE_BUILTIN 호출 부분을 살펴보자.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">NODE_MODULE_CONTEXT_AWARE_BUILTIN(os, node::os::Initialize)<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">C++ 로 작성된 builtin module 소스의 마지막 부분에 이 매크로가 항상 호출된다.<br />그 정의 부분으로 가보면,</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//node.h</span><br /><span class="hljs-preprocessor" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">#<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">define</span> NODE_MODULE_CONTEXT_AWARE_BUILTIN(modname, regfunc)           \</span><br />  NODE_MODULE_CONTEXT_AWARE_X(modname, regfunc, NULL, NM_F_BUILTIN)   \<br /><br /><span class="hljs-preprocessor" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">#<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">define</span> NODE_MODULE_CONTEXT_AWARE_X(modname, regfunc, priv, flags)    \</span><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">extern</span> <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"C"</span> {                                                        \<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">static</span> node::node_module _module =                                \<br />    {                                                                 \<br />      NODE_MODULE_VERSION,                                            \<br />      flags,                                                          \<br />      NULL,                                                           \<br />      __FILE__,                                                       \<br />      NULL,                                                           \<br />      (node::addon_context_register_func) (regfunc),                  \<br />      NODE_STRINGIFY(modname),                                        \<br />      priv,                                                           \<br />      NULL                                                            \<br />    };                                                                \<br />    NODE_C_CTOR(_register_ <span class="hljs-preprocessor" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">## modname) {                              \</span><br />      node_module_register(&amp;_module);                                 \<br />    }                                                                 \<br />  }<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">이렇게 node_module 구조체가 선언된다.<br />node_module 구조체는 다음과 같이 정의되어 있다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//node.h</span><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">struct</span> node_module {<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">int</span> nm_version;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">unsigned</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">int</span> nm_flags;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span>* nm_dso_handle;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span>* nm_filename;<br />  node::addon_register_func nm_register_func;<br />  node::addon_context_register_func nm_context_register_func;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span>* nm_modname;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span>* nm_priv;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">struct</span> node_module* nm_link;<br />};<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">nm_link 가 보이는데 이것을 보면 리스트를 구성하는것을 알수있다.&nbsp; 그러므로, 다음의 매크로 호출의 결과로</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">NODE_MODULE_CONTEXT_AWARE_BUILTIN(os, node::os::Initialize)<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">실제 선언되는 구조체 node_module 은 다음처럼 정의될 것이다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">static</span> node::node_module _module =<br />    {<br />      NODE_MODULE_VERSION,<br />      NM_F_BUILTIN,<br />      NULL,<br />      __FILE__,<br />      NULL,<br />      (node::addon_context_register_func) node::os::Initialize,<br />      <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"os"</span>,<br />      NULL,<br />      NULL<br />    };<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">즉, nm_context_register_func 함수 포인터에 node::os::Initialize 함수가 저장된다.<br />저장된 이함수가 언제 불려지는지는 뒷부분에 설명된다.<br />아무튼, 이 node::os::Initialize 함수가 C++ 함수를 javascript에서 인식가능하게 하는 매크로, NODE_SET_METHOD 호출을 포함하고 있다는 점이 중요하다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">이렇게 하나의 구조체만을 정의했는데, 어떻게 여러개의 builtin module들이 관리되는것일까?&nbsp; 다음의 코드를 보면</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">NODE_C_CTOR(_register_ <span class="hljs-preprocessor" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">## modname) {                              \</span><br />      node_module_register(&amp;_module);                                 \<br />    }<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">node_module_register 함수를 호출해서 지금 생성한 구조체를 리스트에 추가하게 된다.<br />즉, builtin module들은 리스트로 관리가 된다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//node.cc</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">extern</span> <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"C"</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span> node_module_register(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span>* m) {<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">struct</span> node_module* mp = <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">reinterpret_cast</span>&lt;<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">struct</span> node_module*&gt;(m);<br /><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (mp-&gt;nm_flags &amp; NM_F_BUILTIN) {<br />    mp-&gt;nm_link = modlist_builtin;<br />    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//modlist_builtin는</span><br />    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//static node_module* modlist_builtin; 로 정의된 연결리스트이다.</span><br />    modlist_builtin = mp;<br />  } <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">else</span> {<br />    assert(modpending == NULL);<br />    modpending = mp;<br />  }<br />}<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">NODE_C_CTOR 매크로의 역활은 node_module_register 함수가 가장 먼저 호출되게끔 해주는 일을 담당한다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//node.js가 윈도우에서도 동작하므로 ifdef 처리되있음.</span><br /><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//윈도우인 경우처리</span><br /><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//...</span><br /><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//*nix 계열인 경우</span><br /><span class="hljs-preprocessor" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">#<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">define</span> NODE_C_CTOR(fn)                                               \</span><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">static</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span> fn(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span>) __attribute__((constructor));                  \<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">static</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span> fn(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span>)<br /><span class="hljs-preprocessor" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">#<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">endif</span></span><br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">이처럼 javascript에서 사용되길 원하는 모든 C++ builtin module들은 NODE_MODULE_CONTEXT_AWARE_BUILTIN 매크로를 호출하고있다.<br />즉, 모든 builtin module들에 대한 구조체들이 각각 정의되고, 이것들이 modlist_builtin 리스트에 관리된다.</div></div><br /><h1 id="binding--modlist_builtin---" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin-bottom: 16px; margin-left: 0px; margin-right: 0px; margin-top: 0px !important; margin: 0px 0px 16px; padding-bottom: 0.3em; position: relative;">Binding : modlist_builtin 리스트가 사용되는 곳</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">src/node.cc 파일을 보면, 다음과 같은 Binding 함수를 볼수 있을 것이다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">static</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span> Binding(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> FunctionCallbackInfo&lt;Value&gt;&amp; args) {<br />  ...<br /><br />  Local&lt;Object&gt; cache = env-&gt;binding_cache_object();<br />  Local&lt;Object&gt; exports;<br /><br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//먼저 cache 에서 검색하여 존재하면 그것을 리턴한다 ....</span><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (cache-&gt;Has(module)) {<br />    exports = cache-&gt;Get(module)-&gt;ToObject();<br />    args.GetReturnValue().Set(exports);<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span>;<br />  }<br />  ...<br />  node_module* mod = get_builtin_module(*module_v);<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (mod != NULL) {<br />    exports = Object::New(env-&gt;isolate());<br />    ...<br />    Local&lt;Value&gt; unused = Undefined(env-&gt;isolate());<br />    mod-&gt;nm_context_register_func(exports, unused,<br />      env-&gt;context(), mod-&gt;nm_priv);<br />    cache-&gt;Set(module, exports);<br />  } <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">else</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (!<span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">strcmp</span>(*module_v, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"constants"</span>)) {<br />    exports = Object::New(env-&gt;isolate());<br />    DefineConstants(exports);<br />    cache-&gt;Set(module, exports);<br />  } <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">else</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (!<span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">strcmp</span>(*module_v, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"natives"</span>)) {<br />    exports = Object::New(env-&gt;isolate());<br />    DefineJavaScript(env, exports);<br />    cache-&gt;Set(module, exports);<br />  } <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">else</span> {<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span> errmsg[<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1024</span>];<br />    ...<br />  }<br /><br />  args.GetReturnValue().Set(exports);<br />}<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">이 함수에서&nbsp;<b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">get_builtin_module</b>&nbsp;함수를 호출하게 되는데, 그때 modlist_builtin 리스트에서 찾게된다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//node.cc: modlist_builtin 리스트를 검색</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">struct</span> node_module* get_builtin_module(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span>* name) {<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">struct</span> node_module* mp;<br /><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">for</span> (mp = modlist_builtin; mp != NULL; mp = mp-&gt;nm_link) {<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (<span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">strcmp</span>(mp-&gt;nm_modname, name) == <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">0</span>)<br />      <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">break</span>;<br />  }<br /><br />  assert(mp == NULL || (mp-&gt;nm_flags &amp; NM_F_BUILTIN) != <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">0</span>);<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> (mp);<br />}<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">그리고 다음처럼 exports객체를 정의하고, nm_context_register_func 함수 포인터를 이용,<br />각 모듈이 등록해놓은 함수(각 모듈의 초기화 기능) 호출을 하면서 exports 객체를 인자로 넘겨준다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (mod != NULL) {<br />    exports = Object::New(env-&gt;isolate());<br />    ...<br />    Local&lt;Value&gt; unused = Undefined(env-&gt;isolate());<br />    mod-&gt;nm_context_register_func(exports, unused,<br />      env-&gt;context(), mod-&gt;nm_priv);<br />    cache-&gt;Set(module, exports);<br />  }<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">그리고 한번 생성된 객체는 캐쉬에 저장시켜서 다음 요청시에 는 좀 더 빠르게 리턴할수 있게 한다.&nbsp; 앞서 node_os 경우를 예로 들어보자.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">Binding 함수 호출을 하면서 "os" 를 인자로 넘긴 경우,</div><ul style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;"><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">최초로 호출한 경우라면 캐쉬에 없으므로, get_builtin_module 함수호출</div></li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">get_builtin_module 함수에서 modlist_builtin 리스트를 순회하면서 이름으로 검색</div></li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">"os" 이름으로 저장된 구조체에는 다음 정보가 담겨있다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"> {<br />    NODE_MODULE_VERSION,<br />    NM_F_BUILTIN,<br />    NULL,<br />    __FILE__,<br />    NULL,<br />    (node::addon_context_register_func) node::os::Initialize,<br />    "os",<br />    NULL,<br />    NULL<br /> };<br /></code></pre></li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">mod-&gt;nm_context_register_func(exports, unused, env-&gt;context(), mod-&gt;nm_priv); 호출로 실제 실행되는것은 node::os::Initialize 함수이다.</div></li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">node::os::Initialize 함수 인자로는 exports, unused, env-&gt;context(), mod-&gt;nm_priv 가 전달된다.</div></li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">node::os::Initialize 함수 호출로 인해 NODE_SET_METHOD(target, "getCPUs", GetCPUInfo); 등과 같은 NODE_SET_METHOD 들이 모두 호출되어, 전달된 exports 객체에 os 모듈의 각종 함수들이 Set된다.</div></li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">Binding 함수는 exports 객체를 리턴하고 종료한다.</div></li></ul><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;"><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">정리를 하자면 Binding 함수를 이용하면 C++로 구현된 builtin 모듈들이 가진 기능들이 담긴 exports 객체(즉 javascript 에서 사용가능한 객체)를 돌려받을 수 있다는것이다.</b></div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">&nbsp;</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">&nbsp;그런데 이 Binding함수가 역시 C++함수이므로 javascript 에서 이 함수를 호출하기 위해서는 V8 api 를 이용해서 처리해줘야 할것이다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">src/node.cc 파일내에&nbsp;<b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">SetupProcessObject</b>&nbsp;함수를 살펴보자.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">Handle&lt;Object&gt; SetupProcessObject(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">int</span> argc, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span> *argv[])<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">이 함수의 역활은 나중에 설명될것이다. 일단 함수 종료 부분을 보면 다음 코드를 볼수 있다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">...<br />NODE_SET_METHOD(process, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"binding"</span>, Binding);<br />...<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">process 객체에 "binding"이라는 이름으로 Binding c++ 함수를 맵핑시키고 있다.<br />이로서 javascript에서는 다음처럼 원하는 modlist_builtin 리스트에서 해당 모듈의 기능을 사용할수 있다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> binding = process.binding(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'os'</span>);<br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> cpus = binding.getCPUs(); <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// CPU 갯수를 리턴</span>&nbsp;</code></pre><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px;">지금까지 알아본것은, node.js 가 자바스크립트만으로 구현 불가한 기능을 어떻게 javascript 에서 사용가능하게 처리했는지에 대한 것이었다. 이제, process.binding(...)를 이용해서 C++ builtin module을 javascript 에서 사용할수 있게 되었다.</b><br /><br /><h1 id="js-code--node---" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin-bottom: 16px; margin-left: 0px; margin-right: 0px; margin-top: 0px !important; margin: 0px 0px 16px; padding-bottom: 0.3em; position: relative;">js code 가 node에 의해 실행되는 과정</h1><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//fsTest.js</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> fs = <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span>(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'fs'</span>);<br />fs.readFile(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'./bigFile.txt'</span>, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'utf8'</span>, <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(err, data)</span> </span>{<br />  <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">console</span>.log(data);<br />});<br /><span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">console</span>.log(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'exiting...'</span>);<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">그렇다면 사용자가 node ./fsTest.js 를 수행할때 내부적으로 어떤 일들이 발생되는지 알아보자.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">node_main.cc 의 main 함수가 호출되면서 인자가 전달된다.<br />여기서 src/node.cc 의 Start함수를 호출한다.(*nix 계열 기준으로 설명)</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">Start 함수에서 호출되는 주요 함수들은 다음과 같다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//node.cc</span><br />  V8::Initialize();<br />  ...<br />  SetupProcessObject(env, argc, argv, exec_argc, exec_argv);<br />  Load(env);<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">SetupProcessObject 함수가 호출되고 있고, 다음과 같이 정의 되었다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span> SetupProcessObject(Environment* env,<br />                        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">int</span> argc,<br />                        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span>* <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span>* argv,<br />                        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">int</span> exec_argc,<br />                        <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span>* <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span>* exec_argv) {<br />  HandleScope scope(env-&gt;isolate());<br /><br />  Local&lt;Object&gt; process = env-&gt;process_object();<br /><br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//process 객체 속성들을 set 하기 시작한다.</span><br />  ...<br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// process.versions</span><br />  Local&lt;Object&gt; versions = Object::New(env-&gt;isolate());<br />  READONLY_PROPERTY(process, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"versions"</span>, versions);<br />  ...<br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// process.argv</span><br />  Local&lt;Array&gt; arguments = Array::New(env-&gt;isolate(), argc);<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">for</span> (<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">int</span> i = <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">0</span>; i &lt; argc; ++i) {<br />    arguments-&gt;Set(i, String::NewFromUtf8(env-&gt;isolate(), argv[i]));<br />  }<br />  process-&gt;Set(env-&gt;argv_string(), arguments);<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// 모든 인자를 보관!</span><br />  ...<br /><br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//javascript에서 사용가능한 함수를 등록.</span><br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// define various internal methods</span><br />  NODE_SET_METHOD(process,<br />                  <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"_startProfilerIdleNotifier"</span>,<br />                  StartProfilerIdleNotifier);<br />  NODE_SET_METHOD(process,<br />                  <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"_stopProfilerIdleNotifier"</span>,<br />                  StopProfilerIdleNotifier);<br />  NODE_SET_METHOD(process, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"_getActiveRequests"</span>, GetActiveRequests);<br />  NODE_SET_METHOD(process, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"_getActiveHandles"</span>, GetActiveHandles);<br />  NODE_SET_METHOD(process, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"reallyExit"</span>, Exit);<br />  NODE_SET_METHOD(process, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"abort"</span>, Abort);<br />  NODE_SET_METHOD(process, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"chdir"</span>, Chdir);<br />  NODE_SET_METHOD(process, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"cwd"</span>, Cwd);<br />  ...<br /><br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// binding 함수를 등록한다. 이제 이 process 객체만 있으면 binding함수를 호출해서</span><br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// javascript에서 C++ builtin module들의 기능들을 사용할수 있다.</span><br /><br />  NODE_SET_METHOD(process, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"binding"</span>, Binding);<br />  ...<br />}<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">Load 함수가 호출된다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span> Load(Environment* env) {<br />  HandleScope handle_scope(env-&gt;isolate());<br />  ...<br />  Local&lt;String&gt; script_name = FIXED_ONE_BYTE_STRING(env-&gt;isolate(), <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"node.js"</span>);<br />  Local&lt;Value&gt; f_value = ExecuteString(env, MainSource(env), script_name);<br />  ...<br />  Local&lt;Function&gt; f = Local&lt;Function&gt;::Cast(f_value);<br />  ...<br />  Local&lt;Object&gt; global = env-&gt;context()-&gt;Global();<br />  ...<br />  Local&lt;Value&gt; arg = env-&gt;process_object();<br />  f-&gt;Call(global, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span>, &amp;arg);<br />}<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">먼저 다음 코드를 알아보자.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">Local&lt;Value&gt; f_value = ExecuteString(env, MainSource(env), script_name);<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">node_javascript.cc 에 MainSource() 가 정의되어 있다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">Handle&lt;String&gt; MainSource(Environment* env) {<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> OneByteString(env-&gt;isolate(), node_native, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">sizeof</span>(node_native) - <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span>);<br />}<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">OneByteString 정의부분은 다음과 같다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//util-inl.h</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">inline</span> v8::Local&lt;v8::String&gt; OneByteString(v8::Isolate* isolate,<br />                                           <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span>* data,<br />                                           <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">int</span> length) {<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> v8::String::NewFromOneByte(isolate,<br />                                    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">reinterpret_cast</span>&lt;<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> uint8_t*&gt;(data),<br />                                    v8::String::kNormalString,<br />                                    length);<br />}<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">ExecuteString 함수정의는 다음과 같다.<br />이 함수는 자바스크립트 코드 문자열을 인자로 받아서 컴파일후 직접 실행하는 함수이다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//node.cc</span><br /><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// Executes a str within the current v8 context.</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">static</span> Local&lt;Value&gt; ExecuteString(Environment* env,<br />                                  Handle&lt;String&gt; source,<br />                                  Handle&lt;String&gt; filename) {<br />  EscapableHandleScope scope(env-&gt;isolate());<br />  ...<br /><br />  Local&lt;v8::Script&gt; script = v8::Script::Compile(source, filename);<br />  ...<br /><br />  Local&lt;Value&gt; result = script-&gt;Run();<br />  ...&nbsp;</code></pre><span style="color: #333333; font-family: Consolas, 'Liberation Mono', Menlo, Courier, monospace; font-size: 14px; line-height: inherit; white-space: pre;">}</span><br /><br /><h1 id="node_native-natives" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin-bottom: 16px; margin-left: 0px; margin-right: 0px; margin-top: 0px !important; margin: 0px 0px 16px; padding-bottom: 0.3em; position: relative;">node_native, natives</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">그럼 일단, MainSource 함수에서 보이는 node_native 란것은 무엇일까?</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">node.js 소스를 컴파일하는 과정 중에 node/out/Release/obj/gen/ 폴더에 node_native.h가 생성된다. 이 헤더파일에는 아래처럼 node.js 및 lib에 있는 js 코드내용들이 ascii 코드값으로 저장되어 있는 배열들이 정의된다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//node_native.h</span><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span> node_native[] = { <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">32</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">67</span>, ...생략, 배열의 내용은 node.js<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span> _debugger_native[] = { <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">32</span>,... =&gt; 내용은 _debugger.js<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span> _linklist_native[] = { <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">32</span>,...<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span> assert_native[] = { <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">32</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">10.</span>...<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span> buffer_native[] = { <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">32</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">67.</span>...<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span> buffer_ieee754_native[] = { <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>,...<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span> child_process_native[] = { <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>,...<br />  .....<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span> os_native[] = { <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">32</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">67</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">111</span>,... =&gt; os.js 내용이 ascii로 저장됨.<br />  .....<br /><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">struct</span> _native {<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span>* name;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span>* source;<br />  size_t source_len;<br />};<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">그리고 이 배열을 element로 가지는 _native 구조체들의 배열^^, natives 이 존재한다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//node_native.h</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">static</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">struct</span> _native natives[] = {<br />  { <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"node"</span>, node_native, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">sizeof</span>(node_native)-<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span> },<br />  ...<br />  { <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"events"</span>, events_native, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">sizeof</span>(events_native)-<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span> },<br />  { <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"freelist"</span>, freelist_native, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">sizeof</span>(freelist_native)-<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span> },<br />  { <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"fs"</span>, fs_native, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">sizeof</span>(fs_native)-<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span> },<br />  { <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"http"</span>, http_native, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">sizeof</span>(http_native)-<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span> },<br />  ...<br />  { <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"https"</span>, https_native, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">sizeof</span>(https_native)-<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span> },<br />  { <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"module"</span>, module_native, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">sizeof</span>(module_native)-<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span> },<br />  { <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"net"</span>, net_native, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">sizeof</span>(net_native)-<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span> },<br />  { <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"os"</span>, os_native, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">sizeof</span>(os_native)-<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span> },<br />  ...<br />  { NULL, NULL, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">0</span> } <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">/* sentinel */</span><br />};<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">만약 node_native [] 배열이 가진 이 아스키 코드값의 내용을 보고싶다면, char 변환해서 화면에 출력해서 확인 해보면 될것이다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"> <span class="hljs-preprocessor" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">#<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">include</span> &lt;stdio.h&gt;</span><br /> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">int</span> main(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span>)<br /> {<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span> node_native[] = { <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">32</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">67</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">111</span>, ...생략.. ,<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">0</span>};<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">int</span> i = <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">0</span>;<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">while</span> ( node_native [i] ) <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// 친절하게 배열이 0으로 끝난다.</span><br />    {<br />      <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">printf</span>(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"%c"</span>, node_native [i] );<br />      i++;<br />    }<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">0</span>;<br /> }<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">출력되는 내용은 src/node.js 의 코드와 동일하다.&nbsp;&nbsp; 그렇다면, 이것을 통해 우리가 알 수 있는것은..</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">Local&lt;Value&gt; f_value = ExecuteString(env, MainSource(env), script_name);<br /><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//script_name 은 "node.js"가 전달되었음</span><br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">이 함수 호출은, ascii 로 된 javascript 소스를 읽어들여서 그 내용을 실행하는것이다.<br />그리고 실행되는 javascript의 내용은 MainSource() 함수가 돌려주는,</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">char</span> node_native[] = { <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">47</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">32</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">67</span>, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">111</span>, ...생략.. ,<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">0</span>};<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">node_native [] 배열이 될것이고, 배열이 가진 내용은 src/node.js 파일의 내용과 동일하다.<br />그리고 리턴값을 함수로 casting한후 Call함수로 호출하게 된다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">  ...<br />  Local&lt;Function&gt; f = Local&lt;Function&gt;::Cast(f_value);<br />  ...<br />  Local&lt;Object&gt; global = env-&gt;context()-&gt;Global();<br />  ...<br />  Local&lt;Value&gt; arg = env-&gt;process_object();<br /><br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// 입력인자를 전달하면서 node.js (ascii 형태의 소스)코드 실행으로 얻은 함수를 실행.</span><br />  f-&gt;Call(global, <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span>, args);<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">node.js 파일을 열어보면 그내용 자체가 함수인것을 알수있다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">지금 우리는 사용자가 작성한 javascript코드를 node 실행파일이 처리하고 있는 부분을 살펴보고 있다.&nbsp;&nbsp; 하지만 사용자는 node 실행프로그램의 다양한 옵션값도 함께 지정해서 수행중일수도 있다.&nbsp;&nbsp; 그 입력인자들은 어디로 간것인가?</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">앞서 SetupProcessObject 함수 코드를 보면,&nbsp;&nbsp; 다음처럼 사용자의 모든 입력인자들을 저장하고 있는것을 볼수있다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">process-&gt;Set(env-&gt;argv_string(), arguments);<span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// 모든 인자를 보관!</span>&nbsp;</code></pre><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px;">종합해보면, node.js 코드가 사용자가 작성한 javascript를 동작시키는 역활을 하는 것이란것을 알수 있다.</b><br /><br /><h1 id="srcnodejs" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin-bottom: 16px; margin-left: 0px; margin-right: 0px; margin-top: 0px !important; margin: 0px 0px 16px; padding-bottom: 0.3em; position: relative;">src/node.js</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">그렇다면 이제 src 디렉토리에 존재하는 node.js 파일을 확인해 볼 차례이다.<br />이 파일은 다음처럼 시작되고 있다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// This file is invoked by node::Load in src/node.cc, and responsible for</span><br /><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// bootstrapping the node.js core. Special caution is given to the performance</span><br /><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// of the startup process, so many dependencies are invoked lazily.</span><br />(<span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(process)</span> </span>{<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.global = <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>;<br />  .....<br />  <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span> <span class="hljs-title" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">startup</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">()</span><br />  </span>{<br />    ....<br />  }<br />  .......<br />  startup();<br />});<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">주석을 보니, node.js의 core를 초기화 기동시키는 역활을 하고 있다고 되어 있다.<br />익명 함수를 정의하고 있고, 입력인자는 process객체를 받고 있다.<br />() 로 둘러싸있고 이 코드가 수행이 되면, 함수 실행 코드를 리턴하게 된다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">그리고 startup()을 호출 하고있다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span> <span class="hljs-title" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">startup</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">()</span><br /></span>{<br />  ...<br />  startup.globalVariables();<br />  ....<br />  startup.processChannel();<br />  startup.resolveArgv0();<br /><br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//다음은 사용자가 어떤식으로 node 를 실행시켰는지 구분해서 처리한다.</span><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (NativeModule.exists(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'_third_party_main'</span>)) {<br />    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//이부분은 node.js를 사용자가 확장시키기를 원할때 사용된다.</span><br />    ...<br />  } <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">else</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (process.argv[<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span>] == <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'debug'</span>) {<br />    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// Start the debugger agent</span><br />    ...<br />  } <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">else</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (process._eval != <span class="hljs-literal" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">null</span>) {<br />    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// User passed '-e' or '--eval' arguments to Node.</span><br />    evalScript(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'[eval]'</span>);<br />  } <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">else</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (process.argv[<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span>]) {<br />    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// 여기가 사용자의 스크립트를 인자로 실행한 경우에 일반적으로 수행되는 부분이다.</span><br />    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// make process.argv[1] into a full path</span><br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> path = NativeModule.require(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'path'</span>);<br />    process.argv[<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span>] = path.resolve(process.argv[<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span>]);<br />    ...<br />    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//node.js가 구현한 commonJS 모듈 시스템은 NativeModule과 Module 2가지 이다.</span><br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> Module = NativeModule.require(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'module'</span>);<br /><br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (global.v8debug &amp;&amp;<br />        process.execArgv.some(<span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(arg)</span> </span>{<br />          <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> arg.match(<span class="hljs-regexp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #c82829;">/^--debug-brk(=[0-9]*)?$/</span>);<br />        })) {<br />      ...<br />      setTimeout(Module.runMain, debugTimeout);<br /><br />    } <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">else</span> {<br />      <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// Main entry point into most programs:</span><br />      <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// 결국, Module.runMain 으로 사용자의 스크립트를 실행하게 된다.</span><br />      Module.runMain();<br />    }<br />  }<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">else</span> {<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> Module = NativeModule.require(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'module'</span>);<br />    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// 이 부분은 Read-Eval-Print-Loop (REPL) 처리부분이다.</span><br />    ....<br />  }<br />}<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;"><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">결국 Module.runMain 으로 사용자의 스크립트를 실행하게 된다.</b></div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">우리가 관심있는 runMain함수는 다음과 같다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//lib/module.js</span><br />Module.runMain = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">()</span> </span>{<br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// Load the main module--the command line argument.</span><br />  Module._load(process.argv[<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span>], <span class="hljs-literal" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">null</span>, <span class="hljs-literal" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">true</span>);<br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// Handle any nextTicks added in the first tick of the program</span><br />  process._tickCallback();<br />};&nbsp;</code></pre><span face="'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif" style="color: #333333; font-size: 16px; line-height: 25.6px;">여기서 Module 은 node 에서 구현된 모듈 시스템을 의미한다.</span><br /><br /><h1 id="module-system" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin-bottom: 16px; margin-left: 0px; margin-right: 0px; margin-top: 0px !important; margin: 0px 0px 16px; padding-bottom: 0.3em; position: relative;">module system</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">node.js가 구현한 모듈시스템을 살펴보자.<br />즉 다음과 같이, 다른 모듈의 기능을 사용 할 수 있게 해주는 부분이다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> Module = NativeModule.require(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'module'</span>);<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">node.js에서 사용되는 commonJS 모듈 시스템은&nbsp;<b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">Module</b>,&nbsp;<b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">NativeModule</b>&nbsp;2가지로 구분된다.</div><ul style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;"><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;"><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">Module</b>&nbsp;: 우리가&nbsp;<b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">일반적으로 사용하는 모듈 시스템</b>이다.<br />native module, 제 3자(타 개발자 등)가 만든 모듈까지 사용할수 있다. lib/module.js에 정의됨.</div></li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;"><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">NativeModule</b>&nbsp;: native module(node에서 제공하는 js 모듈) 만을 사용하기 위한 용도이다.<br />src/node.js에 정의됨. 일반적으로 사용자가 직접 호출할 경우는 없다.</div></li></ul><span face="'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif" style="color: #333333; font-size: 16px; line-height: 25.6px;">위 예제코드를 보면</span><span face="'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif" style="color: #333333; font-size: 16px; line-height: 25.6px;">&nbsp;</span><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px;">Module 의 기능을 얻기 위해서 NativeModule 을 이용</b><span face="'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif" style="color: #333333; font-size: 16px; line-height: 25.6px;">하고 있는것을 볼수있다. 이것은 약간 미묘한듯 보이지만, Module도 node가 제공하는 native module이므로 NativeModule 를 사용해서 기능을 가져와야 한다.</span><br /><br /><h1 id="module" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin-bottom: 16px; margin-left: 0px; margin-right: 0px; margin-top: 0px !important; margin: 0px 0px 16px; padding-bottom: 0.3em; position: relative;">Module</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">Module은 실질적인 node의 모듈시스템이라고 할수있으며 native module 과 사용자 모듈 모두를 사용할수있게 해준다.&nbsp;&nbsp; 우리가 일상적으로 사용하는require 를 구현하고 있다. 또한 사용자가 작성된 js 를 수행시키는 핵심이기도 하다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">예를들어 사용자가 다음과 같은 스크립트를 작성했다고 가정해보자.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//mymodule.js</span><br />exports.name = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">()</span> </span>{<br />    <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">console</span>.log(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'My name is kojh'</span>); <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//자신이 제공하는 기능을 구현하고, exports 에 저장시킨다.</span><br />};<br /><br /><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//이안에서 native module의 기능이 필요한 경우에도 require함수를 이용 가능하다.</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> myos = <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span>(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'os'</span>); <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//native module 사용 경우</span><br />exports.hostname = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">()</span> </span>{<br />    <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">console</span>.log(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'My hostname is '</span>,myos.hostname());<br />};<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">사용자가 만든 모듈 mymodule.js의 기능을 사용하기 위해 Module이 제공하는 require 함수를 이용할수 있다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//driver.js</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> mymodule = <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span> (<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'./mymodule.js'</span>); <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//사용자의 모듈 사용 경우</span><br />mymodule.hostname();<br />mymodule.name();<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">실행 결과</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-shell" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">$ node driver.js<br />My hostname is  kojh-mb-pro.local<br />My name is kojh<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">이것을 보면 Module의 내부 구현에는 분명, 사용자의 모듈과 native module을 구분해서 처리하는 로직이 존재할 것 같다.&nbsp;&nbsp; 그럼 module.js 를 확인해 보도록 하자.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//lib/module.js</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> NativeModule = <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span>(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'native_module'</span>);<br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> util = NativeModule.require(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'util'</span>);<br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> runInThisContext = <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span>(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'vm'</span>).runInThisContext;<br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> runInNewContext = <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span>(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'vm'</span>).runInNewContext;<br />....<br /><br /><span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span> <span class="hljs-title" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">Module</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(id, parent)</span> </span>{<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.id = id;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.exports = {};<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.parent = parent;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (parent &amp;&amp; parent.children) {<br />    parent.children.push(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>);<br />  }<br /><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.filename = <span class="hljs-literal" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">null</span>;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.loaded = <span class="hljs-literal" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">false</span>;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.children = [];<br />}<br /><span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">module</span>.exports = Module;<br />.....<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">사용자가 작성한 js는 Module.runMain 함수를 통해서 처리되는것을 앞서 볼수 있었다. 결과적으로 Module._load 을 호출하게 된다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">Module._load = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(request, parent, isMain)</span> </span>{<br />  ...<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> filename = Module._resolveFilename(request, parent);<br />  ....<br /><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (NativeModule.exists(filename)) {<br />    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// 사용자가 require('fs') 등, native module을 요청한 경우이다.</span><br />    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// REPL is a special case, because it needs the real require.</span><br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (filename == <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'repl'</span>) {<br />      ...<br />    }<br />    ...<br />    <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//사용자가 require('fs') 같은 native module을 호출한 경우, 아래 부분이 수행될것이다.</span><br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> NativeModule.require(filename);<br />  }<br /><br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//여기부터는 native module 이 아닌경우 처리부분이다.</span><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">module</span> = <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">new</span> Module(filename, parent);<br /><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (isMain) {<br />    process.mainModule = <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">module</span>;<br />    <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">module</span>.id = <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'.'</span>;<br />  }<br />  ...<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">try</span> {<br />    <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">module</span>.load(filename);<br />    hadException = <span class="hljs-literal" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">false</span>;<br />  } <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">finally</span> {<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (hadException) {<br />      <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">delete</span> Module._cache[filename];<br />    }<br />  }<br /><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">module</span>.exports;<br />};<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">짐작했던 것처럼 Module 내부적으로는 native module 과 사용자의 모듈을 구분해서 처리함을 알수있다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">native module 을 이용하기 위해서 NativeModule 를 사용하는데 이는 잠시 뒤 설명하기로 하고, 사용자의 모듈을 처리하는 부분을 따라가 본다. 위 코드에서 다음부터 시작되는 부분이다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">module</span> = <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">new</span> Module(filename, parent);<br />...<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">Module 의 load 함수가 호출되는데 그정의는 다음과 같다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">Module.prototype.load = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(filename)</span> </span>{<br />  ...<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.filename = filename;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.paths = Module._nodeModulePaths(path.dirname(filename));<br /><br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//모듈 확장자가 js 인 경우에, extension 는 'js' 이다.</span><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> extension = path.extname(filename) || <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'.js'</span>;<br /><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (!Module._extensions[extension]) extension = <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'.js'</span>;<br />  Module._extensions[extension](<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>, filename);<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.loaded = <span class="hljs-literal" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">true</span>;<br />};<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">결국</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"> Module._extensions[extension](<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>, filename);<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">이것으로, _extensions 객체에서 extension 키로 찾은 함수를 호출하는 것이다.<br />지금은 사용자 작성 스크립트(mymodule.js)를 실행하는 경우기 때문에, 키는 '.js' 가 된다.<br />그 밖에 .json, .node 확장자의 경우 각각 다른 로직이 수행된다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">그럼 _extensions 을 한번 살펴보자.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// Native extension for .js</span><br />Module._extensions[<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'.js'</span>] = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(module, filename)</span> </span>{<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> content = fs.readFileSync(filename, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'utf8'</span>);<br />  <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">module</span>._compile(stripBOM(content), filename);<br />};<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">해당 key 에 대한 value 로 함수를 설정하고 있다.<br />그리고 그 함수에서는 다시, 주어진 파일명으로 파일을 읽어서 (즉, 사용자의 js 스크립트, mymodule.js) , _compile 함수를 호출한다.<br />사용자의 모듈을 읽기 위해서는 다음처럼 NativeModule.require 를 이용한다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> fs = NativeModule.require(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'fs'</span>); <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//파일을 읽는것은 native module fs.js 이므로</span><br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">나머지 소스도 살펴보면,</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">Module.wrapper = NativeModule.wrapper;<br />Module.wrap = NativeModule.wrap;<br />....<br /><br />Module.prototype.require = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(path)</span> </span>{<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> Module._load(path, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>);<br />};<br /><br />Module.prototype._compile = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(content, filename)</span> </span>{<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> self = <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>;<br />  ...<br />  <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span> <span class="hljs-title" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">require</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(path)</span> </span>{<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> self.require(path);<br />  }<br />  ...<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> dirname = path.dirname(filename);<br />  ...<br />  <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">// create wrapper function</span><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> wrapper = Module.wrap(content);<br /><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> compiledWrapper = runInThisContext(wrapper, { filename: filename });<br />  ...<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> args = [self.exports, <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span>, self, filename, dirname];<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> compiledWrapper.apply(self.exports, args);<br />};<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">여기서, 우리가 일반적으로 사용하는 모듈시스템의 구현, require의 정의를 볼수있다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">Module.prototype.require = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(path)</span> </span>{<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> Module._load(path, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>);<br />};<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">즉 모듈시스템 require는 Module._load를 호출하는 것이다.<br />사용자의 모듈안에서 또다른 모듈을 호출한다면 계속 _load의 재귀적인 호출이 일어날 것이다 (만약 require 호출이 반복된다면 stack overflow 발생).</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">이제 사용자가 작성한 스크립트가 실행되는 부분, _compile에 도착했다.<br /><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">이부분에서 중요한 점은, 사용자가 작성한 모듈은 함수로 변경된다는 점이다.</b><br />즉 다음의 코드를 통해서</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> wrapper = Module.wrap(content);<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;"><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">contents(사용자 모듈의 내용)는 다음과 같은 함수 정의로 변경될것이다.</b></div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">'(function (exports, require, module, __filename, __dirname) {<br />  ...contents source...<br />  });'<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;"><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">이제 모든 모듈안에서 전역으로 사용되던 exports, require, module 등이 어디서 온것인지 알수있다.<br style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;" />그것들은 node가 사용자 모듈을 함수로 변경하면서 인자로 넘겨주는 것들이다.</b></div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;"><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">이제 사용자 스크립트가 다음처럼 인자를 받아서 실행이 된다.</b></div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> args = [self.exports, <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span>, self, filename, dirname];<br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> compiledWrapper.apply(self.exports, args);<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">이때 전달되는 파라메터들을 살펴보자.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> args = [self.exports, <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span>, self, filename, dirname];&nbsp;</code></pre><span face="'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif" style="color: #333333; font-size: 16px; line-height: 25.6px;">즉, 사용자의 모듈입장에서 전달되어진 인자들은</span><span face="'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif" style="color: #333333; font-size: 16px; line-height: 25.6px;">&nbsp;</span><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px;">exports = self.exports , module = self</b><span face="'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif" style="color: #333333; font-size: 16px; line-height: 25.6px;">&nbsp;</span><span face="'Open Sans', 'Clear Sans', 'Helvetica Neue', Helvetica, Arial, sans-serif" style="color: #333333; font-size: 16px; line-height: 25.6px;">이다. 그러므로, 사용자 모듈 입장에서는 exports 는 module.exports와 동일하다.</span><br /><br /><h1 id="nativemodule" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin-bottom: 16px; margin-left: 0px; margin-right: 0px; margin-top: 0px !important; margin: 0px 0px 16px; padding-bottom: 0.3em; position: relative;">NativeModule</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">native module 의 기능을 이용하기 위해서 NativeModule 이 존재한다. 앞서 Module에서 알아본바와 같이 Module 내부에서 node가 기본적으로 제공하는 native module의 기능을 이용할때 NativeModule 를 시용하고 있다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-js" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//node.js</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> ContextifyScript = process.binding(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'contextify'</span>).ContextifyScript;<br /><span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span> <span class="hljs-title" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">runInThisContext</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(code, options)</span> </span>{<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> script = <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">new</span> ContextifyScript(code, options);<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> script.runInThisContext();<br />}<br /><br /><span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span> <span class="hljs-title" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">NativeModule</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(id)</span> </span>{<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.filename = id + <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'.js'</span>;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.id = id;<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.exports = {};<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.loaded = <span class="hljs-literal" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">false</span>;<br />}<br /><br />NativeModule._source = process.binding(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'natives'</span>);<br />NativeModule._cache = {};<br /><br />NativeModule.require = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(id)</span> </span>{<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (id == <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'native_module'</span>) {<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> NativeModule;<br />  }<br />  ...<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> nativeModule = <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">new</span> NativeModule(id);<br /><br />  nativeModule.compile();<br />  nativeModule.cache();<br /><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> nativeModule.exports;<br />};<br />....<br /><br />NativeModule.getSource = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(id)</span> </span>{<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> NativeModule._source[id];<br />}<br /><br />NativeModule.wrap = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(script)</span> </span>{ <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//요청한 js를 함수호출로 감싼다! Module에서와 동일.</span><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> NativeModule.wrapper[<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">0</span>] + script + NativeModule.wrapper[<span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">1</span>];<br />};<br /><br />NativeModule.wrapper = [<br />  <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'(function (exports, require, module, __filename, __dirname) { '</span>,<br />  <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'\n});'</span><br />];<br /><br />NativeModule.prototype.compile = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">()</span> </span>{<br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> source = NativeModule.getSource(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.id);<br />  source = NativeModule.wrap(source);<br /><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> fn = runInThisContext(source, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.filename, <span class="hljs-literal" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">true</span>);<br />  fn(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.exports, NativeModule.require, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.filename);<br /><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.loaded = <span class="hljs-literal" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">true</span>;<br />};<br />.....<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">먼저 process.binding('natives') 호출을 따라가보면, node.cc 파일의 DefineJavaScript() 함수를 호출하게 된다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">static</span> Handle&lt;Value&gt; Binding(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">const</span> Arguments&amp; args) {<br />  HandleScope scope;<br />  ...<br />  } <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">else</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (!<span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">strcmp</span>(*module_v, <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">"natives"</span>)) {<br />    exports = Object::New(env-&gt;isolate());<br />    DefineJavaScript(env, exports);<br />    cache-&gt;Set(module, exports);<br />  }<br />  ...<br />}<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">그럼 DefineJavaScript () 함수에서는 어떤 일을 수행하는지 알아보자.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-cpp" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">/* node_src/node_javascript.cc */</span><br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">void</span> DefineJavaScript(Environment* env, Handle&lt;Object&gt; target) {<br />  HandleScope scope(env-&gt;isolate());<br /><br />  <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">for</span> (<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">int</span> i = <span class="hljs-number" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">0</span>; natives[i].name; i++) {<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (natives[i].source != node_native) {<br />      Local&lt;String&gt; name = String::NewFromUtf8(env-&gt;isolate(), natives[i].name);<br />      Handle&lt;String&gt; source = String::NewFromUtf8(env-&gt;isolate(),<br />                                                  natives[i].source,<br />                                                  String::kNormalString,<br />                                                  natives[i].source_len);<br />      target-&gt;Set(name, source);<br />    }<br />  }<br />}<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">앞서 알아본 바에 의하면, natives 는 node.js의 native javascript파일의 내용을 ascii 형식으로 저장하고 있는 배열 이었다. 이 natives 배열 요소중에서 node_native(즉 node.js파일 내용)를 제외한 것들을 key=모듈명, value=스크립트 내용 으로 target(즉, javascript 객체, exports) 에 설정하게 된다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">그리고 NativeModule.require 정의는 다음과 같다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">NativeModule.require = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(id)</span> </span>{<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (id == <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'native_module'</span>) {<br />      <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> NativeModule;<br />    }<br /><br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> cached = NativeModule.getCached(id);<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (cached) {<br />      <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> cached.exports;<br />    }<br /><br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">if</span> (!NativeModule.exists(id)) {<br />      <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">throw</span> <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">new</span> <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">Error</span>(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'No such native module '</span> + id);<br />    }<br /><br />    process.moduleLoadList.push(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'NativeModule '</span> + id);<br /><br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> nativeModule = <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">new</span> NativeModule(id);<br /><br />    nativeModule.cache();<br />    nativeModule.compile();<br /><br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">return</span> nativeModule.exports;<br />  };<br /></code></pre><h2 id="ex-fsjs-module--" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 1.75em; line-height: 1.225; margin-bottom: 16px; margin-top: 1em; padding-bottom: 0.3em; position: relative;">ex) fs.js module을 요청한 경우</h2><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px;">사용자가 fs.js native module을 요청하는 경우를 알아보자.</div><ul style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;"><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">최초로 호출한 경우라면 캐쉬에 없으므로, new NativeModule('fs') 실행.</div></li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">새로 생성된 객체의 속성은 다음과 같게된다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.filename = <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'fs.js'</span>;<br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.id = <span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'fs'</span>;<br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.exports = {};<br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.loaded = <span class="hljs-literal" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">false</span>;<br /></code></pre></li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">nativeModule.compile(); 이 수행이 된다.</li></ul><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">NativeModule.prototype.compile = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">()</span> </span>{<br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> source = NativeModule.getSource(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.id);<br />    source = NativeModule.wrap(source);<br /><br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> fn = runInThisContext(source, { filename: <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.filename });<br />    fn(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.exports, NativeModule.require, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>, <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.filename);<br /><br />    <span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.loaded = <span class="hljs-literal" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">true</span>;<br />  };<br /></code></pre><ul style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 16px; margin-top: 0px; padding: 0px 0px 0px 2em;"><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">NativeModule._source에서 'fs'를 key로 찾는다. 이미 _source에는 모든 js내용이 해당 key로 존재한다.</li></ul><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; color: #333333; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> source = NativeModule.getSource(<span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">this</span>.id);<br /></code></pre><ul style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px; margin-bottom: 0px; margin-top: 0px; padding: 0px 0px 0px 2em;"><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">NativeModule.wrap(source); 이 돌려주는 결과는 다음과 같은 문자열이 된다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">'(function (exports, require, module, __filename, __dirname) {<br />... 요청한 fs.js 소스 문자열...<br />});'<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;"><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">fs.js 에서 global object 로 사용되는 exports, require, module 이 이제 어디서 오는것인지 알수있다.<br style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;" />그것들은 node 가 fs.js 모듈을 함수 호출로 처리하면서, 인자로 넘겨주는 것들이다. 이는 앞서 Module 에서 처리하는 방식과 동일하다.</b></div></li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">요청한 모듈을 함수로 호출하면서 인자들을 넘겨준다.</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;">fn(this.exports, NativeModule.require, this, this.filename);<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">호출되는 fs.js 의 내부를 잠깐 살펴보면,</div><pre style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background-color: #f7f7f7; border-radius: 3px; border: 0px none; box-sizing: border-box; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; font-size: 14px; line-height: 1.45; margin-bottom: 16px; overflow-wrap: normal; overflow: auto; padding: 16px; white-space: pre-wrap; word-wrap: normal;"><code class="lang-javascript" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; background: transparent none repeat scroll 0% 0%; border-radius: 3px; border: 0px none; box-sizing: border-box; display: inline; font-family: Consolas, &quot;Liberation Mono&quot;, Menlo, Courier, monospace; line-height: inherit; margin: 0px; overflow-wrap: normal; padding: 0px; white-space: pre; word-wrap: normal;"><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//fs.js</span><br />....<br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> util = <span class="hljs-built_in" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">require</span>(<span class="hljs-string" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #718c00;">'util'</span>); <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//require 또한 모듈 호출시 전달된 인자이며, 객체(함수)이다.</span><br />...<br /><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">var</span> fs = exports; <span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//exports 또한 모듈 호출시 전달된 인자.</span><br /><br /><span class="hljs-comment" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8e908c;">//그리고 전달된 exports객체에 자신의 고유 기능을 저장시킨다.</span><br />fs.exists = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(path, callback)</span> </span>{<br />...<br />};<br /><br />fs.existsSync = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(path)</span> </span>{<br />...<br />};<br /><br />fs.readFile = <span class="hljs-function" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #4271ae;"><span class="hljs-keyword" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #8959a8;">function</span><span class="hljs-params" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #f5871f;">(path, encoding_)</span> </span>{<br />...<br /></code></pre><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;"><b style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;">전달된 exports객체에 자신의 고유 기능을 저장 시키는 부분을 확인할수 있다.</b></div></li><li style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box;"><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; margin-bottom: 16px;">이제 exports 객체에는 사용하길 원하는 native module 들이 제공하는 속성이나 함수등이 저장되어 있을 것이다.</div></li></ul><div><h1 id="" style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; border-bottom-color: rgb(238, 238, 238); border-bottom-style: solid; border-bottom-width: 1px; border-bottom: 1px solid rgb(238, 238, 238); box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 2.25em; line-height: 1.2; margin-bottom: 16px; margin-left: 0px; margin-right: 0px; margin-top: 0px !important; margin: 0px 0px 16px; padding-bottom: 0.3em; position: relative;">결론</h1><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px;">사용자가 작성한 자바스크립트는 앞에서 살펴본것처럼 node가 제공하는 프레임워크적인 기능들, 즉 c++로 작성된 builtin과의 연동 및 모듈 시스템을 이용한 타 모듈과의 연동을 통해, javascript만으로 할수 없었던 다양한 부가기능을 구현할수 있게 된다.</div><div style="-webkit-font-smoothing: antialiased; -webkit-tap-highlight-color: transparent; box-sizing: border-box; color: #333333; font-family: &quot;Open Sans&quot;, &quot;Clear Sans&quot;, &quot;Helvetica Neue&quot;, Helvetica, Arial, sans-serif; font-size: 16px; line-height: 25.6px;"><br /></div></div></div><div><br /></div>