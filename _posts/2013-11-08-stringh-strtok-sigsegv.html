---
layout: post
title: string.h 없이 strtok 사용시 SIGSEGV 발생하는 경우
date: '2013-11-08T16:34:00.001+09:00'
author: jeremyko
tags:
- gcc
- strtok
modified_time: '2014-02-21T18:12:41.230+09:00'
blogger_id: tag:blogger.com,1999:blog-7360229670252766698.post-4797062869374216962
blogger_orig_url: https://jeremyko.blogspot.com/2013/11/stringh-strtok-sigsegv.html
---

<span style="font-family: inherit;">다음 코드는 컴파일도 잘되는듯 하고, 간단해서 문제 없이 실행될것 처럼 보인다. 그런데 실행을 해보면 SIGSEGV가 발생하면서 죽어버리는 현상이 발생한다.</span><br /><span style="font-family: Arial, Helvetica, sans-serif;"></span><br /><a name='more'></a><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span> <br /><pre class="sunburst" style="background-color: white; font-family: Inconsolata, Inconsolata, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; line-height: 18.1875px; margin-top: 0em;"><span class="meta meta_preprocessor meta_preprocessor_c meta_preprocessor_c_include">#<span class="keyword keyword_control keyword_control_import keyword_control_import_include keyword_control_import_include_c" style="color: #008800; font-weight: bold;">include</span> <span class="string string_quoted string_quoted_other string_quoted_other_lt-gt string_quoted_other_lt-gt_include string_quoted_other_lt-gt_include_c" style="color: #dd2200;">&lt;stdio.h&gt;</span></span><br /><span class="comment comment_line comment_line_double-slash comment_line_double-slash_c++" style="color: #888888;">//#include &lt;string.h&gt; //!!</span><br /><br /><span class="storage storage_type storage_type_c" style="color: #008800; font-weight: bold;">void</span><span class="meta meta_function meta_function_c"> <span class="entity entity_name entity_name_function entity_name_function_c">testFunc</span> <span class="meta meta_parens meta_parens_c">()</span><br /><span class="meta meta_block meta_block_c">{<br />    <span class="storage storage_type storage_type_c" style="color: #008800; font-weight: bold;">char</span> *pSep = <span class="string string_quoted string_quoted_double string_quoted_double_c" style="color: #dd2200;">"|"</span>;<br />    <span class="storage storage_type storage_type_c" style="color: #008800; font-weight: bold;">char</span> szData [<span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">1024</span>];<br />    <span class="storage storage_type storage_type_c" style="color: #008800; font-weight: bold;">char</span> *p = <span class="constant constant_language constant_language_c" style="color: #003388; font-weight: bold;">NULL</span>;<br />        <br />    <span class="support support_function support_function_C99 support_function_C99_c" style="color: #cc0000; font-weight: bold;">snprintf</span>( szData,<span class="meta meta_function-call meta_function-call_c"> <span class="support support_function support_function_any-method support_function_any-method_c" style="color: #cc0000; font-weight: bold;">sizeof</span>(</span>szData), <span class="string string_quoted string_quoted_double string_quoted_double_c" style="color: #dd2200;">"<span class="constant constant_other constant_other_placeholder constant_other_placeholder_c" style="color: #003388; font-weight: bold;">%s</span>"</span>, <span class="string string_quoted string_quoted_double string_quoted_double_c" style="color: #dd2200;">"1|2,2,4"</span>);<br />    <span class="support support_function support_function_C99 support_function_C99_c" style="color: #cc0000; font-weight: bold;">printf</span>( <span class="string string_quoted string_quoted_double string_quoted_double_c" style="color: #dd2200;">"data[<span class="constant constant_other constant_other_placeholder constant_other_placeholder_c" style="color: #003388; font-weight: bold;">%s</span>]<span class="constant constant_character constant_character_escape constant_character_escape_c" style="color: #003388; font-weight: bold;">\n</span>"</span>, szData );<br /><br />    p = <span class="support support_function support_function_C99 support_function_C99_c" style="color: #cc0000; font-weight: bold;">strtok</span>(szData, pSep );<br />    <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">if</span>(p == <span class="constant constant_language constant_language_c" style="color: #003388; font-weight: bold;">NULL</span>)<br />    <span class="meta meta_block meta_block_c">{<br />        <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">return</span>;<br />    }</span><br />    <span class="support support_function support_function_C99 support_function_C99_c" style="color: #cc0000; font-weight: bold;">printf</span>( <span class="string string_quoted string_quoted_double string_quoted_double_c" style="color: #dd2200;">"p[<span class="constant constant_other constant_other_placeholder constant_other_placeholder_c" style="color: #003388; font-weight: bold;">%s</span>]<span class="constant constant_character constant_character_escape constant_character_escape_c" style="color: #003388; font-weight: bold;">\n</span>"</span>, p );<br />}</span></span><br /><br /><span class="storage storage_type storage_type_c" style="color: #008800; font-weight: bold;">int</span><span class="meta meta_function meta_function_c"> <span class="entity entity_name entity_name_function entity_name_function_c">main</span><span class="meta meta_parens meta_parens_c">()</span><br /><span class="meta meta_block meta_block_c">{<br /><span class="meta meta_function-call meta_function-call_c">    <span class="support support_function support_function_any-method support_function_any-method_c" style="color: #cc0000; font-weight: bold;">testFunc</span> (</span>);<br />    <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">return</span> <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">0</span>;<br />}</span></span></pre><pre class="sunburst" style="background-color: white; font-family: Inconsolata, Inconsolata, Monaco, Consolas, 'Courier New', monospace; font-size: 14px; line-height: 18.1875px; margin-top: 0em;"><span class="meta meta_function meta_function_c"><span class="meta meta_block meta_block_c"><br /></span></span></pre><br /><span style="font-family: Arial, Helvetica, sans-serif;"><span style="color: #134f5c;">/USER/kojh/TestDev]gcc -Wall -g -o test test.c</span></span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">test.c: In function 'testFunc':</span><br /><span style="color: red; font-family: Arial, Helvetica, sans-serif;">test.c:18: warning: implicit declaration of function 'strtok'</span><br /><span style="color: red; font-family: Arial, Helvetica, sans-serif;">test.c:18: warning: assignment makes pointer from integer without a cast</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;"></span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;"><br /></span><span style="font-family: Arial, Helvetica, sans-serif;"><span style="color: #134f5c;"> /USER/kojh/TestDev]gdb test</span></span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">GNU gdb (GDB) Red Hat Enterprise Linux (7.2-48.el6)</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">Copyright (C) 2010 Free Software Foundation, Inc.</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">License GPLv3+: GNU GPL version 3 or later &lt;http://gnu.org/licenses/gpl.html&gt;</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">This is free software: you are free to change and redistribute it.</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">There is NO WARRANTY, to the extent permitted by law. &nbsp;Type "show copying"</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">and "show warranty" for details.</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">This GDB was configured as "x86_64-redhat-linux-gnu".</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">For bug reporting instructions, please see:</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">&lt;http://www.gnu.org/software/gdb/bugs/&gt;...</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">Reading symbols from /OFCS/USER/kojh/TestDev/test...done.</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">(gdb) run</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">Starting program: /USER/kojh/TestDev/test</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">data[1|2,2,4|]</span><br /><span style="color: red; font-family: Arial, Helvetica, sans-serif;">Program received signal SIGSEGV, Segmentation fault.</span><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;"><br /></span><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">0x0000003262048097 in vfprintf () from /lib64/libc.so.6</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">Missing separate debuginfos, use: debuginfo-install glibc-2.12-1.25.el6.x86_64</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">(gdb) bt</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">#0 &nbsp;0x0000003262048097 in vfprintf () from /lib64/libc.so.6</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">#1 &nbsp;0x000000326204f02a in printf () from /lib64/libc.so.6</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">#2 &nbsp;0x00000000004005ef in testFunc () at test.c:23</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">#3 &nbsp;0x0000000000400602 in main () at test.c:28</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">(gdb)</span><br /><span style="font-family: Arial, Helvetica, sans-serif;"><br /></span>  <span style="font-family: Arial, Helvetica, sans-serif;">이 문제는 정확한 헤더를 포함하지 않은 경우, 컴파일러가 임의로 strtok함수의 prototype을&nbsp;</span><br /><span style="font-family: Arial, Helvetica, sans-serif;">가정하기 때문이다.&nbsp;</span><span style="font-family: Arial, Helvetica, sans-serif;">즉, 컴파일러 경고를 보면,</span><br /><span style="color: red; font-family: Arial, Helvetica, sans-serif;">test.c:18: warning: assignment makes pointer from integer without a cast&nbsp;</span><br /><span style="font-family: Arial, Helvetica, sans-serif;">가 출력되는데, &nbsp;다음 부분에서 strtok 함수가 int를 리턴하는것으로 잘못 해석을 하고 있다.</span><br /><span style="font-family: Arial, Helvetica, sans-serif;"><span class="meta meta_function meta_function_c"><span style="color: #0b5394;">p =&nbsp;<span class="support support_function support_function_C99 support_function_C99_c" style="font-weight: bold;">strtok</span>(szData, pSep );</span></span><span class="meta meta_function meta_function_c">&nbsp;</span></span><br /><span style="font-family: Arial, Helvetica, sans-serif;"><br /><span class="meta meta_function meta_function_c">하지만 함수원형은 알다시피 char*를 리턴하는것이 맞다.</span><br /><span class="meta meta_function meta_function_c" style="line-height: 18.1875px;"><span style="color: #134f5c;">char *<b>strtok</b>(char *str, const char *delim);</span></span></span><br /><span style="font-family: Arial, Helvetica, sans-serif;">#include &lt;string.h&gt; 를 include하고 다시 컴파일, 실행시에는 정상처리 된다.<br /><span style="color: #134f5c;"><br /></span></span><br /><span style="font-family: Arial, Helvetica, sans-serif;"><span style="color: #134f5c;">/USER/kojh/TestDev]./test</span></span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">data[1|2,2,4]</span><br /><span style="color: #134f5c; font-family: Arial, Helvetica, sans-serif;">p[1]</span><br /><div><br /></div>