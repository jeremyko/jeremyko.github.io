---
layout: post
title: libcurl POST 한글 encoding
date: '2018-01-10T22:53:00.004+09:00'
author: jeremyko
tags:
- cpp
- curl
- libcurl
modified_time: '2022-03-26T20:57:19.558+09:00'
blogger_id: tag:blogger.com,1999:blog-7360229670252766698.post-7625330704236198543
blogger_orig_url: https://jeremyko.blogspot.com/2018/01/libcurl-post-encoding.html
---

<p>curl 프로그램을 사용하여 POST 전송 시, 한글 데이터를 endcoding 해서 전송하는 방법은 다음과 같다. <br /></p><span><a name='more'></a></span><p><br />curl -d "NAME1=test data" --data-urlencode "NAME2=한글데이터"&nbsp; http://xxx.yyy.zzz<br /><br />-d 옵션으로 여러번 지정을 해도 curl이 merge해줘서 전달되는 데이터는 "NAME1=test data&amp;NAME2=한글데이터" 이 된다. URL-encoding 이 필요한 값은 -d 대신 --data-urlencode&nbsp; 로 지정 해 준다.<br /><br />한편 c++ 에서 libcurl을 사용하여 동일한 작업을 수행하려면 다음처럼 하면 된다.<br /> </p><!--HTML generated using hilite.me--><br /><div style="background: rgb(255, 255, 255) none repeat scroll 0% 0%; border-width: 0.1em 0.1em 0.1em 0.8em; border: medium solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0px;">curl_easy_setopt(curl, CURLOPT_URL, <span style="color: #a31515;">"http://postit.example.com/moo.cgi"</span>);<br /><br /><span style="color: green;">//encoding할 한글데이터만 분리해서 처리 후</span><br /><span style="color: #2b91af;">char</span> temp_buffer[1024];<br /><span style="color: #2b91af;">int</span> len=snprintf(temp_buffer, <span style="color: blue;">sizeof</span>(temp_buffer),<span style="color: #a31515;">"%s"</span>,<span style="color: #a31515;">"한글데이터"</span>);<br /><span style="color: #2b91af;">char</span>* encoded = curl_easy_escape(curl, temp_buffer, len);<br /><br /><span style="color: green;">//하나의 문자열로 조합해야한다.</span><br /><span style="color: #2b91af;">char</span> post_field [1024];<br />snprintf(post_field, <span style="color: blue;">sizeof</span>(post_field),<span style="color: #a31515;">"%s&amp;NAME2=%s"</span>,<span style="color: #a31515;">"NAME1=test data"</span>, encoded);<br />curl_easy_setopt(curl, CURLOPT_POSTFIELDS, post_field);<br /><br />curl_easy_perform(curl);<br />curl_free(encoded);<br /></pre></div><br />curl 프로그램으로 전송할때와 달리 libcurl 사용 시에는 CURLOPT_POSTFIELDS 를 한번만 사용해야 한다. 이를 위해서는 encoding될 한글 데이터만을 별도로 분리하여 curl_easy_escape 함수를 호출해야 한다. 즉 아래처럼 사용하는 경우에는 에러가 발생된다.  <br /><br /><!--HTML generated using hilite.me--><br /><div style="background: rgb(255, 255, 255) none repeat scroll 0% 0%; border-width: 0.1em 0.1em 0.1em 0.8em; border: medium solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0px;"><span style="color: green;">//error 발생!</span><br /><span style="color: #2b91af;">char</span> temp_buffer[1024];<br /><span style="color: #2b91af;">int</span> len=snprintf(temp_buffer, <span style="color: blue;">sizeof</span>(temp_buffer),<span style="color: #a31515;">"%s"</span>,<span style="color: #a31515;">"NAME1=test data&amp;NAME2=한글데이터"</span>);<br /><span style="color: #2b91af;">char</span>* encoded = curl_easy_escape(curl, temp_buffer, len);<br />curl_easy_setopt(curl, CURLOPT_POSTFIELDS, encoded);<br /></pre></div><br />이 경우에는 데이터가 모두 encoding 되면서 '=' 문자도 함께 되버리기 때문에, 받는 쪽에서 에러를 뱉게 된다.<br />curl_easy_escape 함수 문서를 보면 다음과 같이 설명되어 있다.<br />All input characters that are not a-z, A-Z, 0-9, '-', '.', '_' or '~' are converted to their "URL escaped" version (%NN where NN is a two-digit hexadecimal number).<br /><br />처음에 나온 curl 프로그램을 사용하는 경우에는 <br />curl -d "NAME1=test data" --data-urlencode "NAME2=한글데이터"&nbsp; http://xxx.yyy.zzz<br />--data-urlencode "NAME2=한글데이터" 이 부분에서 curl 이 "=" 이후 부분만 알아서 인코딩 해주기 때문에 수신 측에서도 문제가 없다.  하지만 libcurl 은 이런식으로 동작하지 않으므로 주의가 필요할듯.<br /><br /><br /><br />