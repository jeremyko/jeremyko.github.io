---
layout: post
title: protothread
date: '2011-09-21T17:49:00.000+09:00'
author: jeremyko
tags:
- protothread
modified_time: '2012-04-04T17:53:51.383+09:00'
blogger_id: tag:blogger.com,1999:blog-7360229670252766698.post-8924321941478283324
blogger_orig_url: https://jeremyko.blogspot.com/2012/04/protothread.html
---

<div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"><span style="color: #177fcd;"><b><a href="http://www.sics.se/~adam/pt/index.html" style="color: #909090; text-decoration: none;" target="_blank">protothred</a></b>&nbsp;</span>는 주로 쓰레드 사용의 장점이 필요하지만, 기존 쓰레드 생성시의 부하,</span></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;">즉 쓰레드별 스택 생성됨으로 인해 메모리 사용양이 문제가 되는 임베디드 시스템등에서</span></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;">사용할 목적으로&nbsp;</span><span style="font-family: Verdana, arial, helvetica, sans-serif;">작성되었다.&nbsp;</span><span style="font-family: Verdana, arial, helvetica, sans-serif;">쓰레드별 스택이 불필요하므로&nbsp;</span><span style="font-family: Verdana, arial, helvetica, sans-serif;">매우 경량이며</span></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;">(쓰레드당 2 바이트 메모리만 필요</span><span style="font-family: Verdana, arial, helvetica, sans-serif;">)</span><span style="font-family: Verdana, arial, helvetica, sans-serif;">,&nbsp;</span><span style="font-family: Verdana, arial, helvetica, sans-serif;">소스코드의 복잡도 감소등을</span><span style="font-family: Verdana, arial, helvetica, sans-serif;">&nbsp;장점으로 내세운다.</span></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;">C 언어로 작성된 몇개의 헤더파일로만 이루어져 있으며&nbsp;</span><span style="font-family: Verdana, arial, helvetica, sans-serif;">헤더 파일 내부는</span></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;">C 매크로와&nbsp;<b><span style="color: #9b18c1;"><a href="http://goo.gl/tpT0Y" style="color: #909090; text-decoration: none;" target="_blank">먼저 설명한 switch 구문의 마법</a></span></b>을 활용하고 있다. &nbsp;</span></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;">일반적인 쓰레드는 커널에 의해 스케쥴링이 수행되지만, protothread는 프로그램 내부에서</span></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;">각 쓰레드들을&nbsp;</span><span style="font-family: Verdana, arial, helvetica, sans-serif;">스케쥴링하는 부분을 필요로 한다.</span></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"></span><br /><a name='more'></a></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"></span><br /><div><div><span style="font-family: Verdana, arial, helvetica, sans-serif;">protothread 스케쥴링이란 쓰레드 우선 순위에 따라, 직접 수행 순서를 지정해서</span></div><div><span style="font-family: Verdana, arial, helvetica, sans-serif;">어플리케이션에서 루프를 돌면서 함수를 차례로 호출하는 것이다.</span></div><div><div style="font-family: Dotum, Verdana, AppleGothic, sans-serif;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"></span></span><br /><div><span style="font-family: Verdana, arial, helvetica, sans-serif;"><span style="font-family: Verdana, arial, helvetica, sans-serif;">기존 쓰레드에서는 커널에 의해 CPU 처리시간을 할당받으면서 쓰레드간 context 전환이</span></span></div><span style="font-family: Verdana, arial, helvetica, sans-serif;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"><div>발생되면서 작업이 수행되는 반면, protothread는 어플리케이션이 직접 반복적인 함수호출을 하고</div><div>함수 호출의 전환(이것이 기존 쓰레드에서의 context전환 역활)을 통해서 여러작업을 같이</div><div>수행하게 되는 차이점이 있다.</div></span></span></div><div style="font-family: Dotum, Verdana, AppleGothic, sans-serif;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"></span></span><br /><div style="font-family: Dotum, Verdana, AppleGothic, sans-serif;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"><span style="font-family: Verdana, arial, helvetica, sans-serif;">이 덕분에 쓰레드별 스택은 불필요한데, 또 이런 이유로 쓰레드 내부의 지역변수 사용은 제한받게 된다.</span></span></span></div><span style="font-family: Verdana, arial, helvetica, sans-serif;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"><div>즉, 변수값이 유지되지 않기 때문에 정적 지역변수등을 이용하던지 해야한다.</div><div><br /></div></span></span></div></div><div><span style="font-family: Verdana, arial, helvetica, sans-serif;">문서를 보면, 이러한 스케쥴링에 대한 특별한 지침같은 것은 없고, protothread를 사용하는</span></div><div><span style="font-family: Verdana, arial, helvetica, sans-serif;">프로그램에 전적으로 맡기고 있다. 예를 들어, 이벤트 처리방식의 시스템에서 protothread를</span></div><div><span style="font-family: Verdana, arial, helvetica, sans-serif;">사용하는 경우라면, 특정 이벤트 처리시점에 스케쥴링을 해주고, 스케쥴링 루프를 빠져나오기 위해서</span></div><div><span style="font-family: Verdana, arial, helvetica, sans-serif;">모든 쓰레드 처리 완료를 확인하는등의 절차가 필요 할것이다.</span></div></div><span style="font-family: Verdana, arial, helvetica, sans-serif;"><div>그리고 모든 쓰레드 작업을 대체할수 없기 때문에 이를 고려해야한다. 예를 들어 소켓을 이용한</div><div>수신작업이 쓰레드 작업인 경우, 이를 protothread로 완전히 대체할수는 없다. (쓰레드 내에서 이벤트를</div><div>기다리는 경우라면 사용이 제한된다)</div><div><br /></div></span></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;">protothread의 기본적인 사용법은 다음과 같다. (</span><span style="font-family: Verdana, arial, helvetica, sans-serif;">protothread홈페이지에 있는 소스를 그대로 가져왔다)</span></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"><br /></span></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><div class="pastie"><div class="allcode" style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-bottom-width: 1px; border-image: initial; border-left-color: rgb(221, 221, 221); border-left-style: solid; border-left-width: 1px; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-right-width: 1px; border-top-color: rgb(221, 221, 221); border-top-style: solid; border-top-width: 1px; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace; padding-bottom: 5px; padding-left: 10px; padding-right: 10px; padding-top: 5px;"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td style="color: #555555; font-family: 돋움, Dotum; font-size: 12px; line-height: 18px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="textmate-source-numbers" style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; background-position: initial initial; background-repeat: initial initial; color: #999999; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace; padding-right: 12px;">1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />9<br />10<br />11<br />12<br />13<br />14<br />15<br />16<br />17<br />18<br />19<br />20<br />21<br />22<br />23<br />24<br />25<br />26<br />27<br />28<br /></pre></td><td style="color: #555555; font-family: 돋움, Dotum; font-size: 12px; line-height: 18px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="textmate-source" style="background-attachment: initial; background-clip: initial; background-color: white; background-image: initial; background-origin: initial; background-position: initial initial; background-repeat: initial initial; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace;"><pre class="sunburst" style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; background-position: initial initial; background-repeat: initial initial; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace;"><span class="meta meta_preprocessor meta_preprocessor_c meta_preprocessor_c_include">#<span class="keyword keyword_control keyword_control_import keyword_control_import_include keyword_control_import_include_c" style="color: #008800; font-weight: bold;">include</span> <span class="string string_quoted string_quoted_double string_quoted_double_include string_quoted_double_include_c" style="background-color: #fff0f0; color: #dd2200;">"pt.h"</span></span><br /> <br /><span class="storage storage_modifier storage_modifier_c">static</span> <span class="storage storage_type storage_type_c" style="color: #008800; font-weight: bold;">int</span> counter;<br /><span class="storage storage_modifier storage_modifier_c">static</span> <span class="meta meta_class-struct-block meta_class-struct-block_c++"><span class="storage storage_type storage_type_c++" style="color: #008800; font-weight: bold;">struct</span> <span class="entity entity_name entity_name_type entity_name_type_c++">pt</span> example_pt</span>;<br /> <br /><span class="storage storage_modifier storage_modifier_c">static</span> PT_THREAD(example(<span class="meta meta_class-struct-block meta_class-struct-block_c++"><span class="storage storage_type storage_type_c++" style="color: #008800; font-weight: bold;">struct</span> <span class="entity entity_name entity_name_type entity_name_type_c++">pt</span> *pt</span>))<br />{<br />  PT_BEGIN(pt);  <br />  <span class="support support_function support_function_C99 support_function_C99_c" style="color: #cc0000; font-weight: bold;">printf</span>(<span class="string string_quoted string_quoted_double string_quoted_double_c" style="background-color: #fff0f0; color: #dd2200;">"This should be executed just once!<span class="constant constant_character constant_character_escape constant_character_escape_c" style="color: #003388; font-weight: bold;">\n</span>"</span>);  <span class="comment comment_line comment_line_double-slash comment_line_double-slash_c++" style="color: #888888;">//이부분은 테스트목적으로 추가함.</span><br />  <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">while</span>(<span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">1</span>) {<br />    PT_WAIT_UNTIL(pt, counter == <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">1000</span>);<br />    <span class="support support_function support_function_C99 support_function_C99_c" style="color: #cc0000; font-weight: bold;">printf</span>(<span class="string string_quoted string_quoted_double string_quoted_double_c" style="background-color: #fff0f0; color: #dd2200;">"Threshold reached<span class="constant constant_character constant_character_escape constant_character_escape_c" style="color: #003388; font-weight: bold;">\n</span>"</span>);<br />    counter = <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">0</span>;<br />  }<br /> <br />  PT_END(pt);<br />}<br /> <br /><span class="storage storage_type storage_type_c" style="color: #008800; font-weight: bold;">int</span><span class="meta meta_function meta_function_c"> <span class="entity entity_name entity_name_function entity_name_function_c">main</span>(<span class="storage storage_type storage_type_c" style="color: #008800; font-weight: bold;">void</span>)</span><br />{<br />  counter = <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">0</span>;<br />  PT_INIT(&amp;example_pt);   <br />  <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">while</span>(<span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">1</span>) { <span class="comment comment_line comment_line_double-slash comment_line_double-slash_c++" style="color: #888888;">// 직접 스케쥴링을 해줘야한다.</span><br />    example(&amp;example_pt);<br />    counter++;<br />  }<br />  <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">return</span> <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">0</span>;<br />}<br /></pre></pre></td></tr></tbody></table></div><div class="credit" style="background-attachment: initial; background-clip: initial; background-color: #eeeeee; background-image: initial; background-origin: initial; background-position: initial initial; background-repeat: initial initial; border-bottom-color: rgb(204, 204, 204); border-bottom-style: solid; border-bottom-width: 1px; border-image: initial; border-left-color: rgb(204, 204, 204); border-left-style: solid; border-left-width: 1px; border-right-color: rgb(204, 204, 204); border-right-style: solid; border-right-width: 1px; border-top-color: initial; border-top-style: initial; border-top-width: 0px; color: #666666; font-family: 'Lucida Grande', Arial, Helvetica, sans-serif; font-size: 0.7em; padding-bottom: 7px; padding-left: 15px; padding-right: 15px; padding-top: 7px;"><div class="buttons" style="float: right; margin-top: -3px;"><a href="http://pastie.org/pastes/2500343.txt" style="color: #336699; text-decoration: none;"><img height="20" src="http://pastie.org/images/view.png" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px;" width="67" /></a></div><a href="http://pastie.org/2500343" style="color: #336699; text-decoration: none;">Pastie #2500343</a>&nbsp;linked directly from&nbsp;<a href="http://pastie.org/" style="color: #336699; text-decoration: none;">Pastie</a>.</div></div></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><br /></div><div style="background-color: white; color: #555555; font-family: arial, helvetica, sans-serif; font-size: 12px; line-height: 18px; text-align: left;"><span style="font-family: Verdana, arial, helvetica, sans-serif;"></span><br /><div><span style="font-family: Verdana, arial, helvetica, sans-serif;">이 예제에서 가장 중요한 것은 헤더파일에 정의된 PT_ 시작되는 매크로들로서,</span></div><span style="font-family: Verdana, arial, helvetica, sans-serif;"><div>파일을 열어보면 약간의 indirection을 걸치지만 실제 정의는 본질적으로 아래와 같다.</div><div><br /></div><div><div class="pastie"><div class="allcode" style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-bottom-width: 1px; border-image: initial; border-left-color: rgb(221, 221, 221); border-left-style: solid; border-left-width: 1px; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-right-width: 1px; border-top-color: rgb(221, 221, 221); border-top-style: solid; border-top-width: 1px; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace; padding-bottom: 5px; padding-left: 10px; padding-right: 10px; padding-top: 5px;"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td style="color: #555555; font-family: 돋움, Dotum; font-size: 12px; line-height: 18px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="textmate-source-numbers" style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; background-position: initial initial; background-repeat: initial initial; color: #999999; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace; padding-right: 12px;">1<br />2<br />3<br />4<br />5<br />6<br />7<br /></pre></td><td style="color: #555555; font-family: 돋움, Dotum; font-size: 12px; line-height: 18px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="textmate-source" style="background-attachment: initial; background-clip: initial; background-color: white; background-image: initial; background-origin: initial; background-position: initial initial; background-repeat: initial initial; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace;"><pre class="sunburst" style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; background-position: initial initial; background-repeat: initial initial; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace;"><span class="meta meta_class-struct-block meta_class-struct-block_c++"><span class="storage storage_type storage_type_c++" style="color: #008800; font-weight: bold;">struct</span> <span class="entity entity_name entity_name_type entity_name_type_c++">pt</span> { <span class="storage storage_type storage_type_c" style="color: #008800; font-weight: bold;">unsigned</span> <span class="storage storage_type storage_type_c" style="color: #008800; font-weight: bold;">short</span> lc; }</span>; <span class="comment comment_line comment_line_double-slash comment_line_double-slash_c++" style="color: #888888;">//이것이 2byte의 정체...</span><br /><span class="meta meta_preprocessor meta_preprocessor_macro meta_preprocessor_macro_c">#<span class="keyword keyword_control keyword_control_import keyword_control_import_define keyword_control_import_define_c" style="color: #008800; font-weight: bold;">define</span> <span class="entity entity_name entity_name_function entity_name_function_preprocessor entity_name_function_preprocessor_c">PT_THREAD</span>(<span class="variable variable_parameter variable_parameter_preprocessor variable_parameter_preprocessor_c">name_args</span>)  <span class="storage storage_type storage_type_c" style="color: #008800; font-weight: bold;">char</span> name_args</span><br /><span class="meta meta_preprocessor meta_preprocessor_macro meta_preprocessor_macro_c">#<span class="keyword keyword_control keyword_control_import keyword_control_import_define keyword_control_import_define_c" style="color: #008800; font-weight: bold;">define</span> <span class="entity entity_name entity_name_function entity_name_function_preprocessor entity_name_function_preprocessor_c">PT_BEGIN</span>(<span class="variable variable_parameter variable_parameter_preprocessor variable_parameter_preprocessor_c">pt</span>)          <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">switch</span>(pt-&gt;lc) { <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">case</span> <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">0</span>:</span><br /><span class="meta meta_preprocessor meta_preprocessor_macro meta_preprocessor_macro_c">#<span class="keyword keyword_control keyword_control_import keyword_control_import_define keyword_control_import_define_c" style="color: #008800; font-weight: bold;">define</span> <span class="entity entity_name entity_name_function entity_name_function_preprocessor entity_name_function_preprocessor_c">PT_WAIT_UNTIL</span>(<span class="variable variable_parameter variable_parameter_preprocessor variable_parameter_preprocessor_c">pt, c</span>)  pt-&gt;lc = __LINE__; <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">case</span> __LINE__: \</span><br />                              <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">if</span>(!(c)) <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">return</span> <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">0</span><br /><span class="meta meta_preprocessor meta_preprocessor_macro meta_preprocessor_macro_c">#<span class="keyword keyword_control keyword_control_import keyword_control_import_define keyword_control_import_define_c" style="color: #008800; font-weight: bold;">define</span> <span class="entity entity_name entity_name_function entity_name_function_preprocessor entity_name_function_preprocessor_c">PT_END</span>(<span class="variable variable_parameter variable_parameter_preprocessor variable_parameter_preprocessor_c">pt</span>)            } pt-&gt;lc = <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">0</span>; <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">return</span> <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">2</span></span><br /><span class="meta meta_preprocessor meta_preprocessor_macro meta_preprocessor_macro_c">#<span class="keyword keyword_control keyword_control_import keyword_control_import_define keyword_control_import_define_c" style="color: #008800; font-weight: bold;">define</span> <span class="entity entity_name entity_name_function entity_name_function_preprocessor entity_name_function_preprocessor_c">PT_INIT</span>(<span class="variable variable_parameter variable_parameter_preprocessor variable_parameter_preprocessor_c">pt</span>)           pt-&gt;lc = <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">0</span></span><br /></pre></pre></td></tr></tbody></table></div><div class="credit" style="background-attachment: initial; background-clip: initial; background-color: #eeeeee; background-image: initial; background-origin: initial; background-position: initial initial; background-repeat: initial initial; border-bottom-color: rgb(204, 204, 204); border-bottom-style: solid; border-bottom-width: 1px; border-image: initial; border-left-color: rgb(204, 204, 204); border-left-style: solid; border-left-width: 1px; border-right-color: rgb(204, 204, 204); border-right-style: solid; border-right-width: 1px; border-top-color: initial; border-top-style: initial; border-top-width: 0px; color: #666666; font-family: 'Lucida Grande', Arial, Helvetica, sans-serif; font-size: 0.7em; padding-bottom: 7px; padding-left: 15px; padding-right: 15px; padding-top: 7px;"><div class="buttons" style="float: right; margin-top: -3px;"><a href="http://pastie.org/pastes/2500349.txt" style="color: #336699; text-decoration: none;"><img height="20" src="http://pastie.org/images/view.png" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px;" width="67" /></a></div><a href="http://pastie.org/2500349" style="color: #336699; text-decoration: none;">Pastie #2500349</a>&nbsp;linked directly from&nbsp;<a href="http://pastie.org/" style="color: #336699; text-decoration: none;">Pastie</a>.</div></div></div><div><br /></div><div>자 그럼 이 매크로들이 적용되어 확장되는 코드는 아래와 같다.</div><div><br /></div><div><div class="pastie"><div class="allcode" style="border-bottom-color: rgb(221, 221, 221); border-bottom-style: solid; border-bottom-width: 1px; border-image: initial; border-left-color: rgb(221, 221, 221); border-left-style: solid; border-left-width: 1px; border-right-color: rgb(221, 221, 221); border-right-style: solid; border-right-width: 1px; border-top-color: rgb(221, 221, 221); border-top-style: solid; border-top-width: 1px; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace; padding-bottom: 5px; padding-left: 10px; padding-right: 10px; padding-top: 5px;"><table border="0" cellpadding="0" cellspacing="0"><tbody><tr><td style="color: #555555; font-family: 돋움, Dotum; font-size: 12px; line-height: 18px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="textmate-source-numbers" style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; background-position: initial initial; background-repeat: initial initial; color: #999999; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace; padding-right: 12px;">1<br />2<br />3<br />4<br />5<br />6<br />7<br />8<br />9<br />10<br />11<br />12<br />13<br /></pre></td><td style="color: #555555; font-family: 돋움, Dotum; font-size: 12px; line-height: 18px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre class="textmate-source" style="background-attachment: initial; background-clip: initial; background-color: white; background-image: initial; background-origin: initial; background-position: initial initial; background-repeat: initial initial; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace;"><pre class="sunburst" style="background-attachment: initial; background-clip: initial; background-color: transparent; background-image: initial; background-origin: initial; background-position: initial initial; background-repeat: initial initial; font-family: 'Bitstream Vera Sans Mono', Monaco, Consolas, 'Courier New', monospace;"><span class="comment comment_line comment_line_double-slash comment_line_double-slash_c++" style="color: #888888;">//example 함수의 예</span><br /><span class="storage storage_modifier storage_modifier_c">static</span> <span class="storage storage_type storage_type_c" style="color: #008800; font-weight: bold;">char</span> example(<span class="meta meta_class-struct-block meta_class-struct-block_c++"><span class="storage storage_type storage_type_c++" style="color: #008800; font-weight: bold;">struct</span> <span class="entity entity_name entity_name_type entity_name_type_c++">pt</span> *pt</span>)<br />{<br />  <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">switch</span>(pt-&gt;lc) { <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">case</span> <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">0</span>:  <br />  <span class="support support_function support_function_C99 support_function_C99_c" style="color: #cc0000; font-weight: bold;">printf</span>(<span class="string string_quoted string_quoted_double string_quoted_double_c" style="background-color: #fff0f0; color: #dd2200;">"This should be executed just once!<span class="constant constant_character constant_character_escape constant_character_escape_c" style="color: #003388; font-weight: bold;">\n</span>"</span>);  <span class="comment comment_line comment_line_double-slash comment_line_double-slash_c++" style="color: #888888;">// --- (1)</span><br />  <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">while</span>(<span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">1</span>) {<br />    pt-&gt;lc = <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">12</span>; <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">case</span> <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">12</span>:<br />    <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">if</span>(!(counter == <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">1000</span>)) <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">return</span> <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">0</span>;<br />    <span class="support support_function support_function_C99 support_function_C99_c" style="color: #cc0000; font-weight: bold;">printf</span>(<span class="string string_quoted string_quoted_double string_quoted_double_c" style="background-color: #fff0f0; color: #dd2200;">"Threshold reached<span class="constant constant_character constant_character_escape constant_character_escape_c" style="color: #003388; font-weight: bold;">\n</span>"</span>);<br />    counter = <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">0</span>;<br />  }<br />  } pt-&gt;lc = <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">0</span>; <span class="keyword keyword_control keyword_control_c" style="color: #008800; font-weight: bold;">return</span> <span class="constant constant_numeric constant_numeric_c" style="color: #0000dd; font-weight: bold;">2</span>;<br />}<br /></pre></pre></td></tr></tbody></table></div><div class="credit" style="background-attachment: initial; background-clip: initial; background-color: #eeeeee; background-image: initial; background-origin: initial; background-position: initial initial; background-repeat: initial initial; border-bottom-color: rgb(204, 204, 204); border-bottom-style: solid; border-bottom-width: 1px; border-image: initial; border-left-color: rgb(204, 204, 204); border-left-style: solid; border-left-width: 1px; border-right-color: rgb(204, 204, 204); border-right-style: solid; border-right-width: 1px; border-top-color: initial; border-top-style: initial; border-top-width: 0px; color: #666666; font-family: 'Lucida Grande', Arial, Helvetica, sans-serif; font-size: 0.7em; padding-bottom: 7px; padding-left: 15px; padding-right: 15px; padding-top: 7px;"><div class="buttons" style="float: right; margin-top: -3px;"><a href="http://pastie.org/pastes/2500353.txt" style="color: #336699; text-decoration: none;"><img height="20" src="http://pastie.org/images/view.png" style="border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px;" width="67" /></a></div><a href="http://pastie.org/2500353" style="color: #336699; text-decoration: none;">Pastie #2500353</a>&nbsp;linked directly from&nbsp;<a href="http://pastie.org/" style="color: #336699; text-decoration: none;">Pastie</a>.</div></div></div><div><br /></div><div>switch 마법이 다시 등장했다. 이함수가 처음 호출될때는 case 0을 수행하고</div><div>그이후부터는 case 12 부분을 수행하게 된다.</div><div>위의 (1) 부분은 의도한대로 한번만 수행이 된다.</div><div>그런데 12 란 숫자는 하드코딩된 숫자가 아니고 __LINE__ 전처리 매크로를 활용해서</div><div>일반적인 로직으로 처리되게끔 교묘하게 작성된 것이다.</div><div>이러한 함수가 여러번 호출될때마다, 수행되는 위치가 달라지는것은 coroutine과 동일하다.</div><div><br /></div><div>protothread를 사용하는데 있어서의 주의점은 다음과 같다.</div><div>1. 앞서 설명한, 지역변수 사용 제한</div><div>2. protothread와 switch 구문을 동시에 사용할수 없다. 사용시 컴파일 타임 에러가 누락되는 경우가</div><div>&nbsp; &nbsp; 발생한다고 함. 그리고 현재까지 해결책은 없다고 한다.</div></span></div><br />