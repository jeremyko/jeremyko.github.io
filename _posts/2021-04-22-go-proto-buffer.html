---
layout: post
title: 'go 에서 proto buffer 사용하기 '
date: '2021-04-22T21:18:00.010+09:00'
author: jeremyko
tags:
- golang
- proto buffer
modified_time: '2021-05-21T11:17:30.567+09:00'
blogger_id: tag:blogger.com,1999:blog-7360229670252766698.post-1699552116637081071
blogger_orig_url: https://jeremyko.blogspot.com/2021/04/go-proto-buffer.html
---

<p><b>1. proto buffer 를 정의</b> <br /><b>2. go 로 변환하여 모듈을 만들고</b> <br /><b>3. 이 모듈을 로컬에서 호출해서 사용</b> 하는 간단한 예제를 정리해 본다 (go 1.16 버전을 기준)</p><p>최종 코드는 다음을 참고 : <a href="https://github.com/jeremyko/go-proto-buffer-sample" target="_blank">https://github.com/jeremyko/go-proto-buffer-sample </a><br /></p><p><b><span style="color: #38761d;"><span style="font-size: large;"><span></span></span></span></b></p><a name='more'></a><b><span style="color: #38761d;"><span style="font-size: large;">&nbsp;</span></span></b><p></p><p><b><span style="color: #38761d;"><span style="font-size: large;">prerequisite</span></span> <br /></b></p><p style="text-align: left;"><b>&nbsp;&nbsp;&nbsp; </b>protoc, go protocol buffers plugin 설치<b>.&nbsp;</b>&nbsp;&nbsp; </p><p style="margin-left: 40px; text-align: left;"> <span style="color: #2b00fe;">apt install -y protobuf-compiler   <br /><br />    go install google.golang.org/protobuf/cmd/protoc-gen-go</span><br /><br /><span style="color: #660000;"><span style="background-color: #fcff01;"><b>주의점</b></span></span> : protoc-gen-go 는 go version 1.16 이상에서 설치 가능함. <br /></p><div style="margin-left: 40px; text-align: left;">이 조건이 안된다면 go get 으로 바이너리를 직접 받는다. <br /><br /><span style="color: #2b00fe;">go get google.golang.org/protobuf/cmd/protoc-gen-go </span><br /></div><br /><b><br /></b><p></p><p><b>먼저 모듈(</b><b><span style="color: #2b00fe;">github.com/jeremyko/my_proto 라고 정한다)</span>을 만들기 위한 디렉토리를 만든다.</b> <br /></p><p style="margin-left: 40px; text-align: left;"><span style="color: #073763;">mkdir my_proto</span><b> <br /></b></p><p style="margin-left: 40px; text-align: left;"><span style="color: #073763;">cd my_proto<br /></span><br /></p><p><b>my_proto.proto 파일을 생성한다.</b><br /></p><p style="margin-left: 40px; text-align: left;"><span style="color: #073763;"></span></p><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; margin-left: 40px; padding: 4px; text-align: left; white-space: pre;"><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #a17c7b;">syntax </span><span style="background-color: #121214; color: #af9a91;">= </span><span style="background-color: #121214; color: #af5f00;">"proto3"</span><span style="background-color: #121214; color: #af9a91;">;<br /><br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #8faea9;">//package 명은 go_package 에 지정한 경로의 제일 마지막 것으로 해야 한다.<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #91773f;">package </span><span style="background-color: #121214; color: #af9a91;">my_proto ;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #a17c7b;">option </span><span style="background-color: #121214; color: #af9a91;">go_package = </span><span style="background-color: #121214; color: #af5f00;">"github.com/jeremyko/my_proto"</span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #8faea9;">//위 경로는 실제 배포시 적용될 것으로 해준다.<br /><br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #91773f;">message </span><span style="background-color: #121214; color: #af9a91;">MyProto {<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">  </span><span style="background-color: #121214; color: #91773f;">string </span><span style="background-color: #121214; color: #af9a91;">msg = </span><span style="background-color: #121214; color: #af5f00;">1</span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">  </span><span style="background-color: #121214; color: #91773f;">int32  </span><span style="background-color: #121214; color: #af9a91;">number = </span><span style="background-color: #121214; color: #af5f00;">2</span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}</span></div><p>&nbsp;</p><p></p><p><b>proto 파일이 있는 그 위치에 protoc 컴파일한다.</b><br /><br />~/mydev/my_proto#&nbsp; <b><span style="background-color: #fcff01;"><span style="color: #2b00fe;">protoc --go_out=. --go_opt=paths=source_relative --go-grpc_out=. --go-grpc_opt=paths=source_relative&nbsp; my_proto.proto</span></span></b><br /><br />~/my_dev/my_proto# ll<br />total 12<br />-rw-r--r-- 1 root root 4568 Apr 22 14:03 <span style="background-color: #fcff01;"><span style="color: #2b00fe;">my_proto.pb.go</span></span><br />-rw-r--r-- 1 root root&nbsp; 249 Apr 22 13:37 <span style="color: #2b00fe;">my_proto.proto</span><br /></p><p><b>go mod init , go mod tidy 실행 한다.</b><br /><br /></p><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; padding: 4px; white-space: pre;"><span style="color: #cccccc;"><span style="background-color: #121214;">jeremyko</span><span style="background-color: #121214;">: </span><span style="background-color: #121214;">~/mydev/my_proto</span></span><span style="background-color: #121214; color: #af9a91;"># <span style="color: #fcff01;">go mod init github.com/jeremyko/my_proto</span><br />go: creating new go.mod: module github.com/jeremyko/my_proto<br />go: to add module requirements and sums:<br />        go mod tidy<br /></span><span style="color: #cccccc;"><span style="background-color: #121214;">jeremyko</span><span style="background-color: #121214;">: </span><span style="background-color: #121214;">~/mydev/my_proto</span></span><span style="background-color: #121214; color: #af9a91;"># <span style="color: #fcff01;">go mod tidy</span><br />go: finding module for package google.golang.org/protobuf/runtime/protoimpl<br />go: finding module for package google.golang.org/protobuf/reflect/protoreflect    <br />... 생략 <br /></span><span style="color: #cccccc;"><span style="background-color: #121214;">jeremyko</span><span style="background-color: #121214;">: </span><span style="background-color: #121214;">~/mydev/my_proto</span></span><span style="background-color: #121214; color: #af9a91;"># ll<br />total 20<br />-rw-r--r-- 1 jeremyko jeremyko   89 Apr 24 12:41 go.mod<br />-rw-r--r-- 1 jeremyko jeremyko  739 Apr 24 12:41 go.sum<br />-rw-r--r-- 1 jeremyko jeremyko 4534 Apr 24 12:40 my_proto.pb.go<br />-rw-r--r-- 1 jeremyko jeremyko  310 Apr 24 12:39 my_proto.proto<br /></span><span style="color: #cccccc;"><span style="background-color: #121214;">jeremyko</span><span style="background-color: #121214;">: </span><span style="background-color: #121214;">~/mydev/my_proto</span></span><span style="background-color: #121214; color: #af9a91;"># <span style="color: #fcff01;">cat go.mod</span><br />module github.com/jeremyko/my_proto<br /><br />go 1.16<br /><br />require google.golang.org/protobuf v1.26.0</span></div><p>&nbsp;</p><p style="text-align: left;"><b>이제 이 my_proto 모듈을 사용하기 위한 모듈(</b><b><span style="color: #2b00fe;">github.com/jeremyko/proto_test_main)</span>을 별도로 만든다. 새로 만드는 모듈은 main package 를 가지고 단지 my_proto <span style="background-color: #fcff01;">모듈 호출 테스트 용도</span> 이다. (물론 my_proto 모듈 안에서 main package 를 만들어도 상관없다)<br /></b></p><p style="text-align: left;"><b>임의의 위치 (여기서는 </b><b>~/proto_test_main 폴더를 새로 만들었다) 에서 mod init 을 수행한다.</b><br /></p><br /><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; padding: 4px; white-space: pre;"><span style="color: #cccccc;"><span style="background-color: #121214;">jeremyko</span><span style="background-color: #121214;">: </span><span style="background-color: #121214;">~/mydev/proto_test_main</span></span><span style="background-color: #121214; color: #af9a91;"># <span style="color: #fcff01;">go mod init github.com/jeremyko/proto_test_main</span>     <br />go: creating new go.mod: module github.com/jeremyko/proto_test_main<br /></span><span style="color: #cccccc;"><span style="background-color: #121214;">jeremyko</span><span style="background-color: #121214;">: </span><span style="background-color: #121214;">~/mydev/proto_test_main</span></span><span style="background-color: #121214; color: #af9a91;"># <span style="color: #fcff01;">cat go.mod</span><br />module github.com/jeremyko/proto_test_main<br /><br />go 1.16</span></div><p style="text-align: left;"><br /><b>~/my_dev/proto_test_main 에 main.go 를 만든다.</b><br />  <!--HTML generated using hilite.me--></p><div style="background: rgb(240, 243, 243) none repeat scroll 0% 0%; border-color: gray; border-image: none 100% / 1 / 0 stretch; border-style: solid; border-width: 0.1em 0.1em 0.1em 0.8em; border: medium solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0px;"></pre><pre style="line-height: 125%; margin: 0px;"><span style="color: #006699; font-weight: bold;">package</span> main<br /><br /><span style="color: #006699; font-weight: bold;">import</span> (</pre><pre style="line-height: 125%; margin: 0px;"><span style="color: #cc3300;">    "log"</span>&nbsp;</pre><pre style="line-height: 125%; margin: 0px;">    pb <span style="color: #cc3300;">"github.com/jeremyko/my_proto"</span><br />)<br /><br /><span style="color: #006699; font-weight: bold;">func</span> main() {&nbsp;</pre><pre style="line-height: 125%; margin: 0px;">    myProto <span style="color: #555555;">:=</span> <span style="color: #555555;">&amp;</span>pb.MyProto{msg:<span style="color: #cc3300;">"some text"</span>, number:<span style="color: #ff6600;">999</span>}&nbsp;</pre><pre style="line-height: 125%; margin: 0px;">    log.Printf("msg: %s", myProto.Getmsg())<br />    log.Printf("number: %d", myProto.Getnumber())&nbsp;</pre><pre style="line-height: 125%; margin: 0px;">}<br /><br /></pre></div><p><br /><br /><b>로컬에 작성된 my_proto 모듈을 사용하기 위해 일단 mod edit&nbsp; -replace 를 해준다.</b><br /><b>이 내용은 다음링크를 참조</b></p><p><span style="background-color: #fcff01;"><a href="http://jeremyko.blogspot.com/2021/03/golang-module.html" target="_blank">http://jeremyko.blogspot.com/2021/03/golang-module.html&nbsp;</a></span></p><span style="color: #2b00fe;">go mod edit -replace github.com/jeremyko/my_proto=../my_proto</span><p><br /></p><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; padding: 4px; white-space: pre;"><span style="background-color: #121214; color: #d9443f;">jeremyko</span><span style="background-color: #121214; color: #af9a91;">: </span><span style="background-color: #121214; color: #a4dce7;">~/mydev/proto_test_main</span><span style="background-color: #121214; color: #af9a91;"># go mod edit -replace \                      <br />&gt; github.com/jeremyko/my_proto=../my_proto<br /></span><span style="background-color: #121214; color: #d9443f;">jeremyko</span><span style="background-color: #121214; color: #af9a91;">: </span><span style="background-color: #121214; color: #a4dce7;">~/mydev/proto_test_main</span><span style="background-color: #121214; color: #af9a91;"># cat go.mod<br />module github.com/jeremyko/proto_test_main<br /><br />go 1.16<br /><br />replace github.com/jeremyko/my_proto =&gt; ../my_proto</span></div><p><br /></p><p><b>mod tidy 를 수행한다</b><br /></p><p></p><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; padding: 4px; white-space: pre;"><span style="background-color: #121214; color: #d9443f;">jeremyko</span><span style="background-color: #121214; color: #af9a91;">: </span><span style="background-color: #121214; color: #a4dce7;">~/mydev/proto_test_main</span><span style="background-color: #121214; color: #af9a91;"># <span style="color: #fcff01;">go mod tidy</span><br />go: finding module for package github.com/golang/protobuf/proto<br />go: found github.com/golang/protobuf/proto in github.com/golang/protobuf v1.5.2<br />... 생략 <br /></span><span style="background-color: #121214; color: #d9443f;">jeremyko</span><span style="background-color: #121214; color: #af9a91;">: </span><span style="background-color: #121214; color: #a4dce7;">~/mydev/proto_test_main</span><span style="background-color: #121214; color: #af9a91;"># <span style="color: #fcff01;">cat go.mod</span><br />module github.com/jeremyko/proto_test_main<br /><br />go 1.16<br /><br />replace github.com/jeremyko/my_proto =&gt; ../my_proto<br /><br />require (<br />        github.com/golang/protobuf v1.5.2<br />        github.com/jeremyko/my_proto v0.0.0-00010101000000-000000000000<br />)</span></div><p></p><p><br /><br /><b>main.go 를 실행하여 정상여부 확인</b><br /><br /><span style="color: #2b00fe;">go run main.go</span><br /><span style="background-color: #fcff01;"></span></p><p>&nbsp;<span style="background-color: #fcff01;">2021/04/22 14:25:11 msg: some text<br />&nbsp;2021/04/22 14:25:11 number: 999</span></p><p><span style="background-color: #fcff01;"></span></p><p></p><p></p><p>&nbsp;</p><p><b>참고</b></p><p><a href="https://developers.google.com/protocol-buffers/docs/gotutorial">https://developers.google.com/protocol-buffers/docs/gotutorial</a></p><p><span style="background-color: #fcff01;"><br /></span></p><p></p>