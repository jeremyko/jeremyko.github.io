---
layout: post
title: go 에서 gRPC-Gateway 사용하기
date: '2021-04-24T12:03:00.008+09:00'
author: jeremyko
tags:
- golang
- proto buffer
- gRPC-Gateway
- gRPC
modified_time: '2021-04-25T13:09:22.085+09:00'
blogger_id: tag:blogger.com,1999:blog-7360229670252766698.post-6672523820203146098
blogger_orig_url: https://jeremyko.blogspot.com/2021/04/go-grpc-gateway.html
---

<p>이번에는 go 에서 gRPC-Gateway 를 사용하는 방법에 대해 알아보려 한다.&nbsp;</p><p>최종 코드는 다음에서 확인 가능 : <a href="https://github.com/jeremyko/grpc-gateway-sample" target="_blank">https://github.com/jeremyko/grpc-gateway-sample </a><br /></p><p>앞서 살펴본 <a href="http://jeremyko.blogspot.com/2021/04/go-proto-buffer.html" target="_blank">go 에서 proto buffer 사용하기</a> 와 거의 비슷한 절차이나 gRPC-Gateway 사용을 위해 추가되는 절차가 있다. 다음 내용을 기초로 작성되었다 (그대로 따라 했더니 에러가 발생되어, 최신 go 버전에 맞게 내용이 추가된 부분이 있다. go 1.16 버전 기준).<br /><br /><a href="https://grpc-ecosystem.github.io/grpc-gateway/docs/tutorials/introduction/">https://grpc-ecosystem.github.io/grpc-gateway/docs/tutorials/introduction/</a><br /><br /><span style="color: #38761d;"><span style="font-size: large;"><b>필요한 패키지 다운로드</b></span></span> <br /></p><span style="color: #2b00fe;"></span><blockquote><span style="color: #2b00fe;">go get google.golang.org/grpc</span><br /><span style="color: #2b00fe;">go get github.com/grpc-ecosystem/grpc-gateway/v2/protoc-gen-grpc-gateway<br />go get google.golang.org/protobuf/cmd/protoc-gen-go  <br />go get google.golang.org/grpc/cmd/protoc-gen-go-grpc</span></blockquote><h3 style="text-align: left;"><span style="color: #38761d;"><span style="font-size: large;"><b><span><a name='more'></a></span>&nbsp;</b></span></span></h3><h3 style="text-align: left;"><span style="color: #38761d;"><span style="font-size: large;"><b>테스트 grpc 모듈 생성</b></span></span></h3><p style="margin-left: 40px; text-align: left;">임의의 위치에 my_grpc_module 디렉토리 생성. <b>테스트 편의를 위해 main package 를 포함한 모듈을 생성한다</b>. 모듈명은 <span style="color: #2b00fe;">github.com/jeremyko/my_grpc_module</span> 으로 한다.<span style="background-color: #fcff01;"><span style="color: #2b00fe;"><br /></span></span></p><blockquote>root: ~/mydev# <span style="background-color: #fcff01;"><span style="color: #2b00fe;">mkdir my_grpc_module</span></span><br />root: ~/mydev# <span style="color: #2b00fe;">cd my_grpc_module</span></blockquote><span style="color: #2b00fe;"></span><p></p><p><b>go mod init 수행한다</b></p><p></p><blockquote>root: ~/mydev/my_grpc_module# <span style="background-color: #fcff01;"><span style="color: #2b00fe;">go mod init github.com/jeremyko/my_grpc_module</span></span></blockquote><span style="background-color: #fcff01;"><span style="color: #2b00fe;"></span></span> <p></p><p><b>생성된 go.mod 파일 내용 확인</b><br /></p><p style="text-align: left;"></p><blockquote>root: ~/mydev/my_grpc_module# cat go.mod<br />module github.com/jeremyko/my_grpc_module<br />go 1.16</blockquote><b>간단한 테스트용 hello world 서비스를 작성한다</b><br /><p></p><p style="margin-left: 40px; text-align: left;">protocol buffer를 사용하여 gRPC service 를 정의해야 한다. 현위치에서 proto/helloworld/hello_world.proto 파일을 생성한다.<br /></p><p style="text-align: left;"><span style="color: #2b00fe;"></span><span style="color: #2b00fe;"></span></p><blockquote><span style="color: #2b00fe;">mkdir -p proto/helloworld/<br />cd proto/helloworld/<br />touch hello_world.proto</span></blockquote><b>hello_world.proto 파일을 다음처럼 작성한다</b><br /><p></p><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; margin-left: 40px; padding: 4px; text-align: left; white-space: pre;"><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #a17c7b;">syntax </span><span style="background-color: #121214; color: #af9a91;">= </span><span style="background-color: #121214; color: #af5f00;">"proto3"</span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #91773f;">package </span><span style="background-color: #121214; color: #af9a91;">helloworld;<br /><br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #8faea9;">// The greeting service definition<br /></span><span style="background-color: #121214; color: #b55600;">  service </span><span style="background-color: #121214; color: #af9a91;">Greeter {<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #8faea9;">// Sends a greeting<br /></span><span style="background-color: #121214; color: #b55600;">      rpc </span><span style="background-color: #121214; color: #af9a91;">SayHello (HelloRequest) </span><span style="background-color: #121214; color: #b55600;">returns </span><span style="background-color: #121214; color: #af9a91;">(HelloReply) {</span><span style="background-color: #121214; color: #af9a91;">}              <br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #8faea9;">// The request message containing the user's name<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #91773f;">message </span><span style="background-color: #121214; color: #af9a91;">HelloRequest {<br /></span><span style="background-color: #121214; color: #b55600;">    </span><span style="background-color: #121214; color: #91773f;">string </span><span style="background-color: #121214; color: #af9a91;">name = </span><span style="background-color: #121214; color: #af5f00;">1</span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #8faea9;">// The response message containing the greetings<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #91773f;">message </span><span style="background-color: #121214; color: #af9a91;">HelloReply {<br /></span><span style="background-color: #121214; color: #b55600;">    </span><span style="background-color: #121214; color: #91773f;">string message </span><span style="background-color: #121214; color: #af9a91;">= </span><span style="background-color: #121214; color: #af5f00;">1</span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}</span></div><p>&nbsp;</p><p></p><p><b>protoc 혹은 buf 를 사용해서 컴파일 한다. </b>&nbsp;</p><p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; cd ~/mydev/my_grpc_module<br /><span style="color: #2b00fe;"></span></p><blockquote><span style="color: #2b00fe;">protoc -I ./proto --go_out ./proto --go_opt paths=source_relative --go-grpc_out ./proto --go-grpc_opt paths=source_relative ./proto/helloworld/hello_world.proto</span></blockquote><span style="color: #2b00fe;"></span><span style="background-color: #fcff01;"><span style="color: #660000;"><b> </b></span></span>&nbsp;<p></p><p style="margin-left: 40px; text-align: left;"><span style="background-color: #fcff01;"><span style="color: #660000;">튜토리얼 그대로 하면 에러가 발생한다.--&gt; go_package 를 정의해야 함</span></span><br /></p><blockquote><span style="color: #660000;">protoc-gen-go: unable to determine Go import path for "helloworld/hello_world.proto"<br />Please specify either:<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; • <span style="background-color: #fcff01;">a "go_package" option in the .proto source file,</span> or<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; • a "M" argument on the command line.<br />See https://developers.google.com/protocol-buffers/docs/reference/go-generated#package for more information.<br />--go_out: protoc-gen-go: Plugin failed with status code 1.</span></blockquote><div style="margin-left: 40px; text-align: left;"><b>다시 hello_world.proto 파일을 수정한다(package 경로를 모듈명에 덧붙인 형식으로)</b><br /></div><p>&nbsp;</p><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; margin-left: 40px; padding: 4px; text-align: left; white-space: pre;"><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #a17c7b;">syntax </span><span style="background-color: #121214; color: #af9a91;">= </span><span style="background-color: #121214; color: #af5f00;">"proto3"</span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #91773f;">package </span><span style="background-color: #121214; color: #af9a91;">helloworld;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #fcff01;">option go_package = "github.com/jeremyko/my_grpc_module/proto/helloworld" </span><span style="background-color: #121214; color: #af9a91;"><span style="color: black;"><span style="background-color: #fcff01;">;    </span></span><br /><br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #8faea9;">// The greeting service definition<br /></span><span style="background-color: #121214; color: #b55600;">  service </span><span style="background-color: #121214; color: #af9a91;">Greeter {<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #8faea9;">// Sends a greeting<br /></span><span style="background-color: #121214; color: #b55600;">      rpc </span><span style="background-color: #121214; color: #af9a91;">SayHello (HelloRequest) </span><span style="background-color: #121214; color: #b55600;">returns </span><span style="background-color: #121214; color: #af9a91;">(HelloReply) {</span><span style="background-color: #121214; color: #af9a91;">}<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #8faea9;">// The request message containing the user's name<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #91773f;">message </span><span style="background-color: #121214; color: #af9a91;">HelloRequest {<br /></span><span style="background-color: #121214; color: #b55600;">    </span><span style="background-color: #121214; color: #91773f;">string </span><span style="background-color: #121214; color: #af9a91;">name = </span><span style="background-color: #121214; color: #af5f00;">1</span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #8faea9;">// The response message containing the greetings<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #91773f;">message </span><span style="background-color: #121214; color: #af9a91;">HelloReply {<br /></span><span style="background-color: #121214; color: #b55600;">    </span><span style="background-color: #121214; color: #91773f;">string message </span><span style="background-color: #121214; color: #af9a91;">= </span><span style="background-color: #121214; color: #af5f00;">1</span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}</span></div><p>&nbsp;</p><div style="margin-left: 40px; text-align: left;"><b>다시 컴파일 하면 정상적으로 파일들이 생성된다.</b><br /></div><div style="margin-left: 40px;"><span style="color: #2b00fe;"></span></div><span style="color: #2b00fe;"><blockquote>protoc -I ./proto --go_out ./proto --go_opt paths=source_relative --go-grpc_out ./proto --go-grpc_opt paths=source_relative ./proto/helloworld/hello_world.proto</blockquote></span><blockquote>root: ~/mydev/my_grpc_module/proto/helloworld# <span style="color: #2b00fe;">ll</span><br />total 16<br />-rw-r--r-- 1 root root 3445 Apr 23 16:51 hello_world_grpc.pb.go<br />-rw-r--r-- 1 root root 7260 Apr 23 16:51 hello_world.pb.go<br />-rw-r--r-- 1 root root&nbsp; 432 Apr 23 16:51 hello_world.proto</blockquote><p></p><p><b>&nbsp;gRPC server 코드를 작성한다.</b></p><p style="margin-left: 40px; text-align: left;"><span style="background-color: #fcff01;">/root/mydev/my_grpc_module</span> 에 <span style="background-color: #fcff01;"><span style="color: #2b00fe;">main.go</span></span> 를 생성한다<br /></p><p></p><p>&nbsp;<br /></p><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; margin-left: 40px; padding: 4px; text-align: left; white-space: pre;"><span style="background-color: #121214; color: #b55600;">  package </span><span style="background-color: #121214; color: #af9a91;">main<br /><br /></span><span style="background-color: #121214; color: #b55600;">  import </span><span style="background-color: #121214; color: #af9a91;">(<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #af5f00;">"context"<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #af5f00;">"log"<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #af5f00;">"net"<br /><br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #af5f00;">"google.golang.org/grpc"<br /><br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    helloworldpb </span><span style="background-color: #121214; color: #af5f00;">"github.com/jeremyko/my_grpc_module/proto/helloworld" </span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">)<br /><br /></span><span style="background-color: #121214; color: #b55600;">  type </span><span style="background-color: #121214; color: #af9a91;">server </span><span style="background-color: #121214; color: #b55600;">struct</span><span style="background-color: #121214; color: #af9a91;">{}<br /><br /></span><span style="background-color: #121214; color: #b55600;">  func </span><span style="background-color: #121214; color: #af9a91;">NewServer() *server {<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #b55600;">return </span><span style="background-color: #121214; color: #af9a91;">&amp;server{}<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}<br /><br /></span><span style="background-color: #121214; color: #b55600;">  func </span><span style="background-color: #121214; color: #af9a91;">(s *server) SayHello(ctx context.Context, in *helloworldpb.HelloRequest)<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    (*helloworldpb.HelloReply, </span><span style="background-color: #121214; color: #91773f;">error</span><span style="background-color: #121214; color: #af9a91;">) {<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #b55600;">return </span><span style="background-color: #121214; color: #af9a91;">&amp;helloworldpb.HelloReply{Message: in.Name + </span><span style="background-color: #121214; color: #af5f00;">" world"</span><span style="background-color: #121214; color: #af9a91;">}, </span><span style="background-color: #121214; color: #b55600;">nil<br />  </span><span style="background-color: #121214; color: #af9a91;">}<br /><br /></span><span style="background-color: #121214; color: #b55600;">  func </span><span style="background-color: #121214; color: #af9a91;">main() {<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #8faea9;">// Create a listener on TCP port<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    lis, err := net.Listen(</span><span style="background-color: #121214; color: #af5f00;">"tcp"</span><span style="background-color: #121214; color: #af9a91;">, </span><span style="background-color: #121214; color: #af5f00;">":8080"</span><span style="background-color: #121214; color: #af9a91;">)<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #b55600;">if </span><span style="background-color: #121214; color: #af9a91;">err != </span><span style="background-color: #121214; color: #b55600;">nil </span><span style="background-color: #121214; color: #af9a91;">{<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">            log.Fatalln(</span><span style="background-color: #121214; color: #af5f00;">"Failed to listen:"</span><span style="background-color: #121214; color: #af9a91;">, err)<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    }<br /><br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #8faea9;">// Create a gRPC server object<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    s := grpc.NewServer()<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #8faea9;">// Attach the Greeter service to the server<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    helloworldpb.RegisterGreeterServer(s, &amp;server{})<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #8faea9;">// Serve gRPC Server<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    log.Println(</span><span style="background-color: #121214; color: #af5f00;">"Serving gRPC on 0.0.0.0:8080"</span><span style="background-color: #121214; color: #af9a91;">)<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    log.Fatal(s.Serve(lis))<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}</span></div><p></p><span style="font-size: large;"></span><h3><span style="color: #38761d;"><br /></span></h3><h3><span style="color: #38761d;"><span style="font-size: large;"><b>gRPC-Gateway 기능 추가</b></span></span></h3><p></p><p style="margin-left: 40px; text-align: left;">자..여기까지가 Go gRPC server 를 작업한것이고, 이제 추가로 gRPC-Gateway 를 위한 처리가 필요하다. 다시 <b>proto 파일에 다음처럼 변경</b>을 해줘야 한다.</p><p style="text-align: left;"></p><p style="text-align: left;"><span style="color: #2b00fe;"></span></p><blockquote><span style="color: #2b00fe;">import "google/api/annotations.proto"; 를 추가한다</span><br /><span style="color: #2b00fe;">HTTP-&gt;gRPC mapping 을 추가한다 </span></blockquote><span style="color: #2b00fe;"></span><p>&nbsp;</p><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; margin-left: 40px; padding: 4px; text-align: left; white-space: pre;"><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #a17c7b;">syntax </span><span style="background-color: #121214; color: #af9a91;">= </span><span style="background-color: #121214; color: #af5f00;">"proto3"</span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #91773f;">package </span><span style="background-color: #121214; color: #af9a91;">helloworld;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #fff2cc;">import "google/api/annotations.proto"</span><span style="background-color: #121214; color: #af9a91;"><span style="color: black;"><span style="background-color: #fff2cc;">;</span></span><br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #a17c7b;">option </span><span style="background-color: #121214; color: #af9a91;">go_package = </span><span style="background-color: #121214; color: #af5f00;">"github.com/jeremyko/my_grpc_module/proto/helloworld" </span><span style="background-color: #121214; color: #af9a91;">;  <br /><br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #8faea9;">// The greeting service definition<br /></span><span style="background-color: #121214; color: #b55600;">  service </span><span style="background-color: #121214; color: #af9a91;">Greeter {<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #8faea9;">// Sends a greeting<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    </span><span style="background-color: #121214; color: #b55600;">rpc </span><span style="background-color: #121214; color: #af9a91;">SayHello (HelloRequest) </span><span style="background-color: #121214; color: #b55600;">returns </span><span style="background-color: #121214; color: #af9a91;">(HelloReply) {<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">        </span><span style="background-color: #fff2cc;">option </span><span style="background-color: #121214;"><span style="background-color: #fff2cc;">(google.api.http) = {</span><br /></span><span style="background-color: #121214;">  </span><span style="background-color: #121214;">        <span style="background-color: #fff2cc;">  post: </span></span><span style="background-color: #121214;"><span style="background-color: #fff2cc;">"/v1/example/echo"</span><br /></span><span style="background-color: #121214;">  </span><span style="background-color: #121214;">        <span style="background-color: #fff2cc;">  body: </span></span><span style="background-color: #121214;"><span style="background-color: #fff2cc;">"*"</span><br /></span><span style="background-color: #121214;">  </span><span style="background-color: #121214; color: #af9a91;"><span style="color: black;">        <span style="background-color: #fff2cc;">};</span></span><br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">    }<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #8faea9;">// The request message containing the user's name<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #91773f;">message </span><span style="background-color: #121214; color: #af9a91;">HelloRequest {<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">  </span><span style="background-color: #121214; color: #91773f;">string </span><span style="background-color: #121214; color: #af9a91;">name = </span><span style="background-color: #121214; color: #af5f00;">1</span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #8faea9;">// The response message containing the greetings<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #91773f;">message </span><span style="background-color: #121214; color: #af9a91;">HelloReply {<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">  </span><span style="background-color: #121214; color: #91773f;">string message </span><span style="background-color: #121214; color: #af9a91;">= </span><span style="background-color: #121214; color: #af5f00;">1</span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}</span></div><p></p><blockquote></blockquote><br /><p></p><p></p><p style="margin-left: 40px; text-align: left;"><b>이제 stub 코드를 생성한다.&nbsp;&nbsp;</b></p><p style="margin-left: 40px; text-align: left;">protoc 혹은 buf 를 사용한다.<br />protoc 를 사용하는 경우에는 googleapis&nbsp; 의존 파일을 다음 폴더 구조를 만들어서 복사해야 한다.<br /></p><blockquote>proto<br /><span style="background-color: #fcff01;"><span style="color: #2b00fe;">├── google<br />│&nbsp;&nbsp; └── api<br />│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; ├── annotations.proto<br />│&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; └── http.proto</span></span><br />└── helloworld<br />&nbsp;&nbsp;&nbsp; └── hello_world.proto</blockquote><br /><div style="margin-left: 40px;">my_grpc_module/proto/ 에 <span style="color: #2b00fe;">google/api 폴더 생성</span><br /></div><blockquote><span style="color: #2b00fe;">mkdir -p google/api</span></blockquote><p></p><p style="margin-left: 40px; text-align: left;">사용할 googleapis 파일을 가져와야 한다. 임의의 위치에서 git clone 을 수행한다.<br /></p><p></p><p style="margin-left: 40px; text-align: left;"><span style="color: #2b00fe;">git clone https://github.com/googleapis/googleapis.git</span><br /><br />그리고 파일을 복사한다. <br /></p><p style="margin-left: 40px; text-align: left;"><span style="color: #2b00fe;">cd googleapis/google/api</span><br /><span style="color: #2b00fe;">cp annotations.proto&nbsp; /root/mydev/my_grpc_module/proto/google/api/.</span><br /><span style="color: #2b00fe;">cp http.proto&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; /root/mydev/my_grpc_module/proto/google/api/.</span><br /></p><p><br /></p><p style="margin-left: 40px; text-align: left;"><b>gRPC-Gateway generator 추가를 위해 protoc 를 실행한다.</b><br /></p><p></p><p style="margin-left: 40px; text-align: left;">cd ~/mydev/my_grpc_module/<br /><br />root: ~/mydev/my_grpc_module#&nbsp; <span style="color: #2b00fe;">protoc -I ./proto --go_out ./proto --go_opt paths=source_relative --go-grpc_out ./proto --go-grpc_opt paths=source_relative --grpc-gateway_out ./proto --grpc-gateway_opt paths=source_relative ./proto/helloworld/hello_world.proto</span><br /></p><p></p><p style="margin-left: 40px; text-align: left;"><b>실행하면 hello_world.pb.gw.go 파일이 생성된다.</b><br /><br />root: ~/mydev/my_grpc_module/proto/helloworld# <span style="color: #2b00fe;">ll</span><br />total 24<br />-rw-r--r-- 1 root root 3445 Apr 23 17:20 hello_world_grpc.pb.go<br />-rw-r--r-- 1 root root 7664 Apr 23 17:20 hello_world.pb.go<br />-rw-r--r-- 1 root root 6377 Apr 23 17:20 <span style="background-color: #fcff01;">hello_world.pb.gw.go</span><br />-rw-r--r-- 1 root root&nbsp; 586 Apr 23 17:10 hello_world.proto<br /><br /><b>main.go 를 수정한다</b><br /></p><p></p><p>&nbsp;</p><p style="margin-left: 40px;"></p><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; margin-left: 40px; padding: 4px; text-align: left; white-space: pre;"><span style="background-color: #121214; color: #b55600;">  package </span><span style="background-color: #121214; color: #af9a91;">main<br /><br /></span><span style="background-color: #121214; color: #b55600;">  import </span><span style="background-color: #121214; color: #af9a91;">(<br /></span><span style="background-color: #121214; color: #b55600;">     </span><span style="background-color: #121214; color: #af5f00;">"context"<br /></span><span style="background-color: #121214; color: #b55600;">     </span><span style="background-color: #121214; color: #af5f00;">"log"<br /></span><span style="background-color: #121214; color: #b55600;">     </span><span style="background-color: #121214; color: #af5f00;">"net"<br /></span><span style="background-color: #121214; color: #b55600;">     </span><span style="background-color: #121214; color: #af5f00;"><span style="color: black;"><span style="background-color: #fff2cc;">"net/http" //추가</span></span><br /></span><span style="background-color: #121214; color: #b55600;">     </span><span style="background-color: #121214; color: #af5f00;"><span style="color: black;"><span style="background-color: #fff2cc;">"github.com/grpc-ecosystem/grpc-gateway/v2/runtime" //추가</span></span><br /><br /></span><span style="background-color: #121214; color: #b55600;">     </span><span style="background-color: #121214; color: #af5f00;">"google.golang.org/grpc"<br /><br /></span><span style="background-color: #121214; color: #b55600;">     </span><span style="background-color: #121214; color: #af9a91;">helloworldpb </span><span style="background-color: #121214; color: #af5f00;">"github.com/jeremyko/my_grpc_module/proto/helloworld" </span><span style="background-color: #121214; color: #af9a91;">;<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">)<br /><br /></span><span style="background-color: #121214; color: #b55600;">  type </span><span style="background-color: #121214; color: #af9a91;">server </span><span style="background-color: #121214; color: #b55600;">struct</span><span style="background-color: #121214; color: #af9a91;">{<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;"><span style="color: black;"><span style="background-color: #fff2cc;">helloworldpb.UnimplementedGreeterServer //추가</span></span><br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}<br /><br /></span><span style="background-color: #121214; color: #b55600;">  func </span><span style="background-color: #121214; color: #af9a91;">NewServer() *server {<br /></span><span style="background-color: #121214; color: #b55600;">      return </span><span style="background-color: #121214; color: #af9a91;">&amp;server{}<br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}<br /><br /></span><span style="background-color: #121214; color: #b55600;">  func </span><span style="background-color: #121214; color: #af9a91;">(s *server) SayHello(ctx context.Context, in *helloworldpb.HelloRequest)<br /></span><span style="background-color: #121214; color: #b55600;">     </span><span style="background-color: #121214; color: #af9a91;">(*helloworldpb.HelloReply, </span><span style="background-color: #121214; color: #91773f;">error</span><span style="background-color: #121214; color: #af9a91;">) {<br /></span><span style="background-color: #121214; color: #b55600;">      return </span><span style="background-color: #121214; color: #af9a91;">&amp;helloworldpb.HelloReply{Message: in.Name + </span><span style="background-color: #121214; color: #af5f00;">" world"</span><span style="background-color: #121214; color: #af9a91;">}, </span><span style="background-color: #121214; color: #b55600;">nil<br />  </span><span style="background-color: #121214; color: #af9a91;">}<br /><br /></span><span style="background-color: #121214; color: #b55600;">  func </span><span style="background-color: #121214; color: #af9a91;">main() {<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #8faea9;">// Create a listener on TCP port<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">lis, err := net.Listen(</span><span style="background-color: #121214; color: #af5f00;">"tcp"</span><span style="background-color: #121214; color: #af9a91;">, </span><span style="background-color: #121214; color: #af5f00;">":8080"</span><span style="background-color: #121214; color: #af9a91;">)<br /></span><span style="background-color: #121214; color: #b55600;">      if </span><span style="background-color: #121214; color: #af9a91;">err != </span><span style="background-color: #121214; color: #b55600;">nil </span><span style="background-color: #121214; color: #af9a91;">{<br /></span><span style="background-color: #121214; color: #b55600;">          </span><span style="background-color: #121214; color: #af9a91;">log.Fatalln(</span><span style="background-color: #121214; color: #af5f00;">"Failed to listen:"</span><span style="background-color: #121214; color: #af9a91;">, err)<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">}<br /><br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #8faea9;">// Create a gRPC server object<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">s := grpc.NewServer()<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #8faea9;">// Attach the Greeter service to the server<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">helloworldpb.RegisterGreeterServer(s, &amp;server{})<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #8faea9;">// Serve gRPC Server<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">log.Println(</span><span style="background-color: #121214; color: #af5f00;">"Serving gRPC on 0.0.0.0:8080"</span><span style="background-color: #121214; color: #af9a91;">)<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #8faea9;"><span style="color: black;"><span style="background-color: #fff2cc;">//log.Fatal(s.Serve(lis)) //막고 다음을 추가</span></span><br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #8faea9;">//------------------------------------------ <span style="color: #660000;"><span style="background-color: #fcff01;">START</span></span><br /></span><span style="background-color: #121214; color: #b55600;">      go </span><span style="background-color: #121214; color: #91773f;">func</span><span style="background-color: #121214; color: #af9a91;">() {<br /></span><span style="background-color: #121214; color: #b55600;">          </span><span style="background-color: #121214; color: #af9a91;">log.Fatalln(s.Serve(lis))<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">}()<br /><br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #8faea9;">// Create a client connection to the gRPC server we just started<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #8faea9;">// This is where the gRPC-Gateway proxies the requests<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">conn, err := grpc.DialContext(<br /></span><span style="background-color: #121214; color: #b55600;">          </span><span style="background-color: #121214; color: #af9a91;">context.Background(),<br /></span><span style="background-color: #121214; color: #b55600;">          </span><span style="background-color: #121214; color: #af5f00;">"0.0.0.0:8080"</span><span style="background-color: #121214; color: #af9a91;">,<br /></span><span style="background-color: #121214; color: #b55600;">          </span><span style="background-color: #121214; color: #af9a91;">grpc.WithBlock(),<br /></span><span style="background-color: #121214; color: #b55600;">          </span><span style="background-color: #121214; color: #af9a91;">grpc.WithInsecure(),<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">)<br /></span><span style="background-color: #121214; color: #b55600;">      if </span><span style="background-color: #121214; color: #af9a91;">err != </span><span style="background-color: #121214; color: #b55600;">nil </span><span style="background-color: #121214; color: #af9a91;">{<br /></span><span style="background-color: #121214; color: #b55600;">          </span><span style="background-color: #121214; color: #af9a91;">log.Fatalln(</span><span style="background-color: #121214; color: #af5f00;">"Failed to dial server:"</span><span style="background-color: #121214; color: #af9a91;">, err)<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">}<br /><br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">gwmux := runtime.NewServeMux()<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #8faea9;">// Register Greeter<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">err = helloworldpb.RegisterGreeterHandler(context.Background(), gwmux, </span><span style="background-color: #4e4b61; color: #af9a91;">c</span><span style="background-color: #121214; color: #af9a91;">onn)<br /></span><span style="background-color: #121214; color: #b55600;">      if </span><span style="background-color: #121214; color: #af9a91;">err != </span><span style="background-color: #121214; color: #b55600;">nil </span><span style="background-color: #121214; color: #af9a91;">{<br /></span><span style="background-color: #121214; color: #b55600;">          </span><span style="background-color: #121214; color: #af9a91;">log.Fatalln(</span><span style="background-color: #121214; color: #af5f00;">"Failed to register gateway:"</span><span style="background-color: #121214; color: #af9a91;">, err)<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">}<br /><br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">gwServer := &amp;http.Server{</span><span style="background-color: #121214; color: #b55600;">&nbsp;<br />         &nbsp;</span><span style="background-color: #121214; color: #af9a91;">Addr:    </span><span style="background-color: #121214; color: #af5f00;">":8090"</span><span style="background-color: #121214; color: #af9a91;">,<br /></span><span style="background-color: #121214; color: #b55600;">          </span><span style="background-color: #121214; color: #af9a91;">Handler: gwmux,<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">}<br /><br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">log.Println(</span><span style="background-color: #121214; color: #af5f00;">"Serving gRPC-Gateway on http://0.0.0.0:8090"</span><span style="background-color: #121214; color: #af9a91;">)<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #af9a91;">log.Fatalln(gwServer.ListenAndServe())<br /></span><span style="background-color: #121214; color: #b55600;">      </span><span style="background-color: #121214; color: #8faea9;">//------------------------------------------ <span style="color: #660000;"><span style="background-color: #fcff01;">END</span></span><br /></span><span style="background-color: #121214; color: #b55600;">  </span><span style="background-color: #121214; color: #af9a91;">}</span>&nbsp;</div><p></p><p><br /></p><p></p><blockquote></blockquote><p></p><p style="margin-left: 40px; text-align: left;"><b>go mod tidy 실행 </b><br /></p><p></p><blockquote><br /><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; padding: 4px; white-space: pre;"><span style="background-color: #121214; color: #d9443f;">jeremyko</span><span style="background-color: #121214; color: #af9a91;">: </span><span style="background-color: #121214; color: #a4dce7;">~/mydev/go_dev/my_grpc_module</span><span style="background-color: #121214; color: #af9a91;"># go mod tidy<br />go: finding module for package google.golang.org/grpc/codes<br />go: finding module for package google.golang.org/grpc/grpclog<br />go: finding module for package google.golang.org/genproto/googleapis/api/annotations<br />go: finding module for package github.com/grpc-ecosystem/grpc-gateway/v2/utilities<br />go: finding module for package github.com/grpc-ecosystem/grpc-gateway/v2/runtime<br />go: finding module for package google.golang.org/grpc/metadata<br />go: finding module for package google.golang.org/grpc<br />... 중략 ...<br />go: downloading github.com/golang/protobuf v1.5.2<br />go: downloading golang.org/x/net v0.0.0-20210316092652-d523dce5a7f4<br />go: downloading golang.org/x/sys v0.0.0-20210320140829-1e4c9ba3b0c4</span></div></blockquote><p></p><p><b><br /></b></p><h3 style="text-align: left;"><b><span style="color: #38761d;"><span style="font-size: large;">서버 실행</span></span>&nbsp;</b></h3><p style="margin-left: 40px; text-align: left;"><b>&nbsp;</b>자체에서 main package 로 테스트 하는 경우이므로 이제 바로 서버를 실행할수 있다.&nbsp; <br /></p><p></p><br /><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; margin-left: 40px; padding: 4px; text-align: left; white-space: pre;"><span style="background-color: #121214; color: #d9443f;">jeremyko</span><span style="background-color: #121214; color: #af9a91;">: </span><span style="background-color: #121214; color: #a4dce7;">~/mydev/go_dev/my_grpc_module</span><span style="background-color: #121214; color: #af9a91;"># go run main.go<br />2021/04/24 11:28:47 Serving gRPC on 0.0.0.0:8080<br />2021/04/24 11:28:47 Serving gRPC-Gateway on http://0.0.0.0:8090</span></div><p style="margin-left: 40px; text-align: left;"><br /><b>서버로 http post 요청을 보내본다 </b><br />curl -X POST -k http://localhost:8090/v1/example/echo -d '{"name": " hello"}'<br /></p><div style="background-color: #121214; display: inline-block; font-family: &quot;D2Coding&quot;, monospace; font-size: 11pt; margin-left: 40px; padding: 4px; text-align: left; white-space: pre;"><span style="background-color: #121214; color: #d9443f;">jeremyko</span><span style="background-color: #121214; color: #af9a91;">: </span><span style="background-color: #121214; color: #a4dce7;">~</span><span style="background-color: #121214; color: #af9a91;"># curl -X POST -k http://localhost:8090/v1/example/echo -d '{"name": " hello"}'<br />{"message":" hello world"}</span><span style="background-color: #121214; color: #d9443f;">jeremyko</span><span style="background-color: #121214; color: #af9a91;">: </span><span style="background-color: #121214; color: #a4dce7;">~</span><span style="background-color: #121214; color: #af9a91;">#</span></div><p style="margin-left: 40px; text-align: left;"><br />서버 응답이 오는것을 확인할수 있다.<br /></p><p><br /></p><h3 style="text-align: left;"><span style="color: #38761d;"><span style="font-size: large;"><b>느낀점</b></span></span></h3><p style="margin-left: 40px; text-align: left;">해줘야 할게 많고 복잡 ㅠ<br /></p><p><br /></p><p></p><p></p><p></p>