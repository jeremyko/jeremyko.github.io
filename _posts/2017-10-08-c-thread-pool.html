---
layout: post
title: c++ thread pool
date: '2017-10-08T13:35:00.007+09:00'
author: jeremyko
tags:
- cpp
- c++11
modified_time: '2022-03-26T20:57:51.717+09:00'
blogger_id: tag:blogger.com,1999:blog-7360229670252766698.post-96266151791272400
blogger_orig_url: https://jeremyko.blogspot.com/2017/10/c-thread-pool.html
---

<p><br /><b><a href="https://github.com/jeremyko/kothreadpool" target="_blank">https://github.com/jeremyko/kothreadpool</a></b><br /></p><span><a name='more'></a></span><p><br />간단한 worker thread pool 정도만 필요해서 하나 만들어 보았다. <br />사용법은 다음과 같다.<br /><br /> <!--HTML generated using hilite.me--></p><div style="background: rgb(240, 240, 240) none repeat scroll 0% 0%; border-color: gray; border-image: none 100% / 1 / 0 stretch; border-style: solid; border-width: 0.1em 0.1em 0.1em 0.8em; border: medium solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0px;"><span style="color: #007020;">#include &lt;iostream&gt;</span><br /><span style="color: #007020;">#include &lt;string&gt;</span><br /><span style="color: #007020;">#include &lt;atomic&gt;</span><br /><span style="color: #007020;">#include "KoThreadPool.hpp"</span><br /><br />std<span style="color: #666666;">::</span>atomic<span style="color: #666666;">&lt;</span><span style="color: #902000;">int</span><span style="color: #666666;">&gt;</span> gSum1;<br />std<span style="color: #666666;">::</span>atomic<span style="color: #666666;">&lt;</span><span style="color: #902000;">int</span><span style="color: #666666;">&gt;</span> gSum2;<br /><br /><br /><span style="color: #902000;">bool</span> <span style="color: #06287e;">MyThreadWork</span>() {<br />    gSum1<span style="color: #666666;">++</span>;<br />    <span style="color: #007020; font-weight: bold;">return</span> <span style="color: #007020;">true</span>;<br />}<br /><br /><span style="color: #007020; font-weight: bold;">class</span> <span style="color: #0e84b5; font-weight: bold;">MyClass</span><br />{<br />    <span style="color: #002070; font-weight: bold;">public:</span><br />        MyClass()  {} ;<br />        <span style="color: #666666;">~</span>MyClass() {} ;<br /><br />        <span style="color: #902000;">bool</span> <span style="color: #06287e;">MyThreadWork</span>() {<br />            gSum2<span style="color: #666666;">++</span>;<br />            <span style="color: #007020; font-weight: bold;">return</span> <span style="color: #007020;">true</span>;<br />        }<br />};<br /><br /><br /><span style="color: #902000;">int</span> <span style="color: #06287e;">main</span>()<br />{<br />    KoThreadPool tpool;<br /><br />    <span style="color: #007020; font-weight: bold;">if</span>( <span style="color: #666666;">!</span> tpool.InitThreadPool() ) {<br />        std<span style="color: #666666;">::</span>cerr <span style="color: #666666;">&lt;&lt;</span> <span style="color: #4070a0;">"Error : Init"</span> <span style="color: #666666;">&lt;&lt;</span> <span style="color: #4070a0;">"</span><span style="color: #4070a0; font-weight: bold;">\n</span><span style="color: #4070a0;">"</span>;<br />        exit(<span style="color: #40a070;">1</span>);<br />    }<br />    tpool.SetWaitingCnt(<span style="color: #40a070;">2</span>); <span style="color: #60a0b0; font-style: italic;">//set total work count</span><br />    gSum1 <span style="color: #666666;">=</span> <span style="color: #40a070;">0</span>;<br />    gSum2 <span style="color: #666666;">=</span> <span style="color: #40a070;">0</span>;<br />    MyClass myclass;<br /><br />    <span style="color: #60a0b0; font-style: italic;">//class member</span><br />    std<span style="color: #666666;">::</span>function<span style="color: #666666;">&lt;</span><span style="color: #902000;">void</span>()<span style="color: #666666;">&gt;</span> temp_func1 <span style="color: #666666;">=</span> std<span style="color: #666666;">::</span>bind( <span style="color: #666666;">&amp;</span>MyClass<span style="color: #666666;">::</span>MyThreadWork, <span style="color: #666666;">&amp;</span>myclass)  ;<br />    tpool.AssignTask(temp_func1 )  ;<br /><br />    <span style="color: #60a0b0; font-style: italic;">//free function</span><br />    std<span style="color: #666666;">::</span>function<span style="color: #666666;">&lt;</span><span style="color: #902000;">void</span>()<span style="color: #666666;">&gt;</span> temp_func2 <span style="color: #666666;">=</span> std<span style="color: #666666;">::</span>bind( <span style="color: #666666;">&amp;</span>MyThreadWork )  ;<br />    tpool.AssignTask(temp_func2 )  ;<br /><br />    <span style="color: #60a0b0; font-style: italic;">//wait all 2 works done.</span><br />    tpool.WaitAllWorkDone(); <span style="color: #60a0b0; font-style: italic;">// --&gt; XXX blocking call.</span><br /><br />    <span style="color: #60a0b0; font-style: italic;">//At the end of the program, exit the thread pool.</span><br />    tpool.Terminate(); <span style="color: #60a0b0; font-style: italic;">//graceful terminate : wait until all work done</span><br />    <span style="color: #60a0b0; font-style: italic;">//tpool.Terminate(true); //terminate immediately</span><br /><br />    std<span style="color: #666666;">::</span>cout <span style="color: #666666;">&lt;&lt;</span> <span style="color: #4070a0;">"gSum1 ="</span> <span style="color: #666666;">&lt;&lt;</span> gSum1 <span style="color: #666666;">&lt;&lt;</span> <span style="color: #4070a0;">"</span><span style="color: #4070a0; font-weight: bold;">\n</span><span style="color: #4070a0;">"</span>;<br />    std<span style="color: #666666;">::</span>cout <span style="color: #666666;">&lt;&lt;</span> <span style="color: #4070a0;">"gSum2 ="</span> <span style="color: #666666;">&lt;&lt;</span> gSum2 <span style="color: #666666;">&lt;&lt;</span> <span style="color: #4070a0;">"</span><span style="color: #4070a0; font-weight: bold;">\n</span><span style="color: #4070a0;">"</span>;<br /><br />    <span style="color: #007020; font-weight: bold;">return</span> <span style="color: #40a070;">0</span>;<br />}<br /></pre></div>  <br /><br /><span><!--more--></span>