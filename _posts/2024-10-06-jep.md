---
layout: post
title: 'tablesaw, jep : java 에서 pandas를 사용하기'
date: 2024-10-06 21:40:00 +0900

tags: [java, tablesaw, jep, python, numpy, pandas]
---

**java에서 python 코드를 사용하려면 jep 을 이용해서 기존코드 (파이선모듈의 C 종속성 상관없이)를 그대로 활용할수 있다**
{: .notice--success}

기존에 python pandas로 작성된 코드를 java 환경에서 사용해야 하는 경우가 있다. pandas 는 기여자만 3000 명이 넘는, 수많은 기능을 포함하고 있는 방대한 라이브러리다. 이런 라이브러리를 이용해서 개발된 python 코드를 어떻게 java 에서 어떻게 사용할 것인가? 그 방법을 찾다보니 알게된 **`tablesaw`** 와 **`jep`** 이라는 오픈소스에 대해 간단히 적어본다. 

## [tablesaw](https://github.com/jtablesaw/tablesaw) ## 

pandas 의 dataframe 과 비슷한 **`Table`** 이라는 클래스를 제공한다. 단어 그대로 데이터들로 구성된 단순한 테이블이다. pandas 의 index 라는 개념은 없고, 그냥 column, row 만 존재한다. import, export, 필터링 등  기능을 제공하지만 pandas 에 비해 많이 부족한 수준이다. github 에도 신규 개발은 거의 중단 상태로 보인다. 

제공 안되는 함수는 필요시 직접 로직을 구현해야 한다. (~~예?~~).  
예를들어 `pivot` 의 경우, 아주 간단하게 제공을 해주지만 pandas 에서 사용하던 방식대로 사용하려면 직접 그 로직을 구현해야 한다.

`merge` 도 마찬가지로 pandas 만큼 인자가 다양하지도 않고, 그 때문에 다양한 방식으로 사용할 수 없다. pandas 에서 함수 인자를 어떻게 사용하느냐에 따라 결과가 달라지는 그 모든것을 일일히 다 구현해줘야 한다.
 
그나마 위 경우는 비슷한 기능을 제공이라도 하지만 없는것이 대부분이다 . `vectorization` 도 지원하지 않는다 (~~당신이 for loop 로 직접 구현해야~~). 

![image](/assets/img/20241006_1.jpg){: width="400"}

최근 프로젝트에서 알아볼 시간도 없어서 그냥 이것으로 개발했는데, pandas 의 로직을 java 에서 tablesaw 이용해서 구현하고 결과가 python 과 동일한지 전부 검증 하는 방식으로 개발을 해야 했다. 하다보니 이런 식으로 개발 하는것은 전혀 바람직하지 않다는 시행 착오를 겪게 되었다.


## [jep](https://github.com/ninia/jep) ## 


java 에 임베디드된 python 으로, java에서 python 을 실행해서 pandas, numpy 를 사용할 수 있다. JNI 와 CPython API 를 이용해서 JVM 내부에서 Python 인터프리터를 시작해서 python 호출을 가능하게 해준다. 

이미 작성되어 있는 python 코드를 그대로 실행 가능하고 java , python 간에 데이터를 주고 받게 해서 연동 할 수 있다. pandas, numpy 등 C 에 종속된 특정 python 모듈 사용에도 제약이 없다는 큰 장점을 가지고 있다. 


다음처럼 설치 하면

    pip install jep

python 모듈 저장소에 jar 파일이 저장된다 (windows기준). 

    C:\Python311\Lib\site-packages\jep\jep-4.2.0.jar

이것을 classpath 에 추가를 해주면 된다
(intellij 등의 IDE 를 사용하는 경우에는 라이브러리로 추가).

그리고 window 환경변수 path 에 다음 경로를 추가 해준다 
    
    C:\Python311\Lib\site-packages\jep

java 에서 python 을 실행하는것은 다음과 같다.

```java
package org.kojh;

import java.nio.file.Files;
import java.nio.file.Path;
import jep.Interpreter;
import jep.SharedInterpreter;

public class Main {

    public static void main(String[] args) throws Exception{
        try (Interpreter interp = new SharedInterpreter()) {
            interp.exec("import pandas as pd");
            interp.exec("import numpy as np");
            interp.exec("dates = pd.date_range('1/1/2000', periods=8)");
            interp.exec("df = pd.DataFrame(np.random.randn(8, 4), index=dates, columns=['A', 'B', 'C', 'D'])");
            Object result1 = interp.getValue("df");
            System.out.println(result1);            
        }
    }
}
```

python 스크립트 파일도 실행 가능하다.  
다음과 같이 `test.py` 라는 python 코드를 java 에서 호출하는 경우를 가정해본다.

```python
import pandas as pd
import numpy as np

df1 = pd.DataFrame({'lkey': ['foo', 'bar', 'baz', 'foo'], 'value': [1, 2, 3, 5]})
df2 = pd.DataFrame({'rkey': ['foo', 'bar', 'baz', 'foo'], 'value': [5, 6, 7, 8]})
merged1 = df1.merge(df2, left_on='lkey', right_on='rkey')
merged2 = df1.merge(df2, left_on='lkey', right_on='rkey', suffixes=('_left', '_right'))

df = pd.DataFrame({'a': [10., 20., 30., 40., 50.],
                   'b': [None, None, None, None, 500]},
                  index=pd.DatetimeIndex(['2018-02-27 09:01:00',
                                          '2018-02-27 09:02:00',
                                          '2018-02-27 09:03:00',
                                          '2018-02-27 09:04:00',
                                          '2018-02-27 09:05:00']))
asof_result = df.asof(pd.DatetimeIndex(['2018-02-27 09:03:30', '2018-02-27 09:04:30']))          
```

그럼 다음처럼 호출해서 python 코드내의 변수 df에 접근할수 있다.

```java
package org.kojh;

import java.nio.file.Files;
import java.nio.file.Path;
import jep.Interpreter;
import jep.SharedInterpreter;

public class Main {

    public static void main(String[] args) throws Exception{
        try (Interpreter interp = new SharedInterpreter()) {
            Path filePath = Path.of("test.py");
            String pyCode = Files.readString(filePath);
            interp.exec(pyCode);
            
            Object result = interp.getValue("merged1");
            System.out.println(result);
            result = interp.getValue("asof_result");
            System.out.println(result);
        }
    }
}
```

### 참 고 ###

numpy (pandas) 등과 같이 C 언어에 종속성을 가진 python 모듈인 경우에는 java 에서 호출하기가 쉽지 않다. 예를 들어 **[`jython`](https://www.jython.org/)** 이라는 것도 있지만 pandas, numpy 를 사용할수 없다. 

오라클에서 만든 **[`GraalPy`](https://www.graalvm.org/latest/reference-manual/python/)** 도 있는데, Python, JavaScript 및 기타 언어를 내장하여 Java 애플리케이션을 확장할 수 있다고 한다. 
그런데 테스트 해보니 일단 windows에서는 [제약](https://www.graalvm.org/latest/reference-manual/python/Python-Runtime/#windows)이 많아서 pandas 사용은 불가능했고, linux 인 경우에는 동작은 하는데, 내가 테스트해 본 결과는 약 30배 정도 속도 저하가 발생되었다. 그리고 장점으로 내세우고 있는 네이티브 바이너리로 컴파일 가능한 것도 시간이 너무 많이 걸렸다 (아주 간단한 것도 거의 10분).



