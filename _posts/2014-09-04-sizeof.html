---
layout: post
title: '내가 본 거지같은 소스들 - sizeof 와 구조체 패딩  '
date: '2014-09-04T00:40:00.002+09:00'
author: jeremyko
tags:
- cpp
- 내가 봐온 거지같은 소스들
modified_time: '2022-03-26T21:01:03.773+09:00'
blogger_id: tag:blogger.com,1999:blog-7360229670252766698.post-8419522171115448808
blogger_orig_url: https://jeremyko.blogspot.com/2014/09/sizeof.html
---

<h3 class="post-title entry-title" itemprop="name"> </h3><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">지금까지 일한곳들에 존재하는, 거지 같은 소스들을 유지, 보수하면서 느낀점들을 정리한다. &nbsp;</span><br /><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><br /></span> <span style="color: #0b5394; font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><b>sizeof 와 구조체 패딩</b></span><br /><span style="font-family: inherit;"><br /><span style="color: #0b5394;"><span style="color: black;">결론만 먼저 얘기하면, 구조체 크기를 임의로 가정해서 이 수치를 가지고 연산하지 말라는 것이다.</span></span> 구조체를 &nbsp;다룰때 네트워크 연동등이 아니라면, 일반적으로 패딩 바이트에 대해 신경 쓸일은 없다. 그런데 네트워크 연동이 아니더라도 구조체 크기를 임의로 판단, offset 으로 멤버에 접근을 시도하면 문제가 될수 있다는 것을 아래에서 보여주고 있다.</span><br /><span style="font-family: inherit;"><br /><span style="color: #0b5394;"><span style="color: black;">먼저, 다음과 같은 형태의 데이터를 빈번하게 파일에 쓰는 경우를 생각해보자.</span></span></span><br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.4em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902; font-style: italic;">#define MAX_DATA_SIZE  2048</span><br /><br /><span style="color: #204a87; font-weight: bold;">typedef</span> <span style="color: #204a87; font-weight: bold;">struct</span> <span style="color: black;">__FileBlock</span><br /><span style="color: black; font-weight: bold;">{</span><br />    <span style="color: #204a87; font-weight: bold;">char</span>     <span style="color: black;">strData1</span> <span style="color: black; font-weight: bold;">[</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: black; font-weight: bold;">];</span><br />    <span style="color: #204a87; font-weight: bold;">int</span>      <span style="color: black;">nNumber1</span>  <span style="color: black; font-weight: bold;">;</span> <span style="color: #8f5902; font-style: italic;">//4byte</span><br />    <span style="color: #204a87; font-weight: bold;">int</span>      <span style="color: black;">nNumber2</span>  <span style="color: black; font-weight: bold;">;</span> <span style="color: #8f5902; font-style: italic;">//4byte</span><br />    <span style="color: #204a87; font-weight: bold;">int</span>      <span style="color: black;">nNumber3</span>  <span style="color: black; font-weight: bold;">;</span> <span style="color: #8f5902; font-style: italic;">//4byte</span><br />    <span style="color: #204a87; font-weight: bold;">char</span>     <span style="color: black;">strData2</span> <span style="color: black; font-weight: bold;">[</span><span style="color: #0000cf; font-weight: bold;">50</span><span style="color: black; font-weight: bold;">];</span><br />    <span style="color: #204a87; font-weight: bold;">char</span>     <span style="color: black;">strData3</span> <span style="color: black; font-weight: bold;">[</span><span style="color: black;">MAX_DATA_SIZE</span><span style="color: black; font-weight: bold;">];</span><br /><span style="color: black; font-weight: bold;">}</span> <span style="color: black;">ItemFileBlock</span><span style="color: black; font-weight: bold;">;</span><br /></pre></div><br /><br /><span style="font-family: inherit;">그리고 이 구조체 변수에 값을 채우고 파일에 그대로 저장하는 경우를 위한 함수를 하나 작성했다,</span><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.4em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #204a87; font-weight: bold;">bool</span> <span style="color: black;">SaveDataToFile</span><span style="color: black; font-weight: bold;">(</span><span style="color: black;">ItemFileBlock</span><span style="color: #ce5c00; font-weight: bold;">*</span> <span style="color: black;">pstFileBlock</span><span style="color: black; font-weight: bold;">)</span><br /><span style="color: black; font-weight: bold;">{</span><br />    <span style="color: #8f5902; font-style: italic;">//m_clsFile 는 파일 I/O 를 담당하는 객체</span><br />    <span style="color: #8f5902; font-style: italic;">//구조체를 sizeof(ItemFileBlock) 크기만큼 파일에 저장.</span><br />    <span style="color: #204a87; font-weight: bold;">if</span><span style="color: black; font-weight: bold;">(</span> !<span style="color: black;">m_clsFile</span><span style="color: black; font-weight: bold;">.</span><span style="color: black;">WriteRecord</span><span style="color: black; font-weight: bold;">((</span><span style="color: #204a87; font-weight: bold;">char</span><span style="color: #ce5c00; font-weight: bold;">*</span><span style="color: black; font-weight: bold;">)</span><span style="color: black;">pstFileBlock</span><span style="color: black; font-weight: bold;">,</span> <span style="color: #204a87; font-weight: bold;">sizeof</span><span style="color: black; font-weight: bold;">(</span><span style="color: black;">ItemFileBlock</span><span style="color: black; font-weight: bold;">))</span><span style="color: black; font-weight: bold;">)</span><br />    <span style="color: black; font-weight: bold;">{</span><br />        <span style="color: #204a87; font-weight: bold;">return</span> <span style="color: #204a87;">false</span><span style="color: black; font-weight: bold;">;</span><br />    <span style="color: black; font-weight: bold;">}</span>     <br />    <span style="color: #204a87; font-weight: bold;">return</span> <span style="color: #204a87;">true</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">}</span><br /></pre></div><br /><br /><span style="font-family: inherit;">그리고 이함수를 이용해서 데이터를 저장.</span><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.4em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: black;">ItemFileBlock</span> <span style="color: black;">stFileBlock</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #8f5902; font-style: italic;">//이제 stFileBlock 의 항목을 채운다. </span><br /><span style="color: #8f5902; font-style: italic;">//.....</span><br /><br /><span style="color: #8f5902; font-style: italic;">//pData3 는 이미 사용자의 정보를 가르키고 있는 포인터 이다.</span><br /><span style="color: black;">memcpy</span><span style="color: black; font-weight: bold;">(</span><span style="color: #ce5c00; font-weight: bold;">&amp;</span><span style="color: black;">stFileBlock</span><span style="color: black; font-weight: bold;">.</span><span style="color: black;">strData3</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">pData3</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">MAX_DATA_SIZE</span><span style="color: black; font-weight: bold;">);</span> <span style="color: #8f5902; font-style: italic;">//흠 복사 할 게 좀 많네  </span><br /><br /><span style="color: #8f5902; font-style: italic;">//함수 호출</span><br /><span style="color: #204a87; font-weight: bold;">if</span><span style="color: black; font-weight: bold;">(</span><span style="color: #ce5c00; font-weight: bold;">!</span><span style="color: black;">SaveDataToFile</span><span style="color: black; font-weight: bold;">(</span><span style="color: #ce5c00; font-weight: bold;">&amp;</span><span style="color: black;">stFileBlock</span><span style="color: black; font-weight: bold;">)){</span><br />    <span style="color: black; font-weight: bold;">....</span><br /><span style="color: black; font-weight: bold;">}</span><br /></pre></div><br /><br /><span style="font-family: inherit;">여기까지는 좋다. 뭐 그냥 파일에 구조체 크기만큼 저장하는거니까 이걸로 OK.</span><br /><span style="font-family: inherit;"><br /></span> <span style="font-family: inherit;">그런데 이 개발자는 strData3 항목에 계속 데이터를 복사하는게 마음에 걸린 모양이다. 이미 이 항목에 저장할 데이터의 포인터(pData3)를 가지고 있어서, 굳이 복사를 안해도 될것 같아 성능 향상(실제로 성능이 향상될거 같<span style="font-family: inherit;">지는 않다. file I/O가 추가됬으니 - -)</span>을 목적으로 SaveDataToFile 함수를 다음처럼 수정했다.</span><br /><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.4em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902; font-style: italic;">//이젠 strData3에 저장될 데이터를 포인터로 받는다.</span><br /><span style="color: #204a87; font-weight: bold;">bool</span> <span style="color: black;">SaveDataToFile</span><span style="color: black; font-weight: bold;">(</span><span style="color: black;">ItemFileBlock</span><span style="color: #ce5c00; font-weight: bold;">*</span> <span style="color: black;">pstFileBlock</span><span style="color: black; font-weight: bold;">,</span> <span style="color: #204a87; font-weight: bold;">char</span><span style="color: #ce5c00; font-weight: bold;">*</span> <span style="color: black;">pData3</span><span style="color: black; font-weight: bold;">)</span><br /><span style="color: black; font-weight: bold;">{</span><br />    <span style="color: #8f5902; font-style: italic;">//2번에 나눠 파일에 저장. 한번은 strData3 이전 데이터</span><br />    <span style="color: #8f5902; font-style: italic;">// !!! sizeof(ItemFileBlock)-MAX_DATA_SIZE 이것은 ?!</span><br />    <span style="color: #204a87; font-weight: bold;">if</span><span style="color: black; font-weight: bold;">(</span> <span style="color: #ce5c00; font-weight: bold;">!</span><span style="color: black;">m_clsFile</span><span style="color: black; font-weight: bold;">.</span><span style="color: black;">WriteRecord</span><span style="color: black; font-weight: bold;">((</span><span style="color: #204a87; font-weight: bold;">char</span><span style="color: #ce5c00; font-weight: bold;">*</span><span style="color: black; font-weight: bold;">)</span><span style="color: black;">pstFileBlock</span><span style="color: black; font-weight: bold;">,</span> <br />                              <span style="color: #204a87; font-weight: bold;">sizeof</span><span style="color: black; font-weight: bold;">(</span><span style="color: black;">ItemFileBlock</span><span style="color: black; font-weight: bold;">)</span><span style="color: #ce5c00; font-weight: bold;">-</span><span style="color: black;">MAX_DATA_SIZE</span><span style="color: black; font-weight: bold;">)</span> <span style="color: black; font-weight: bold;">)</span><br />    <span style="color: black; font-weight: bold;">{</span><br />        <span style="color: #204a87; font-weight: bold;">return</span> <span style="color: #204a87;">false</span><span style="color: black; font-weight: bold;">;</span><br />    <span style="color: black; font-weight: bold;">}</span><br />    <br />    <span style="color: #8f5902; font-style: italic;">//strrData3은 여기서 저장된다  </span><br />    <span style="color: #204a87; font-weight: bold;">if</span><span style="color: black; font-weight: bold;">(</span> <span style="color: #ce5c00; font-weight: bold;">!</span><span style="color: black;">m_clsFile</span><span style="color: black; font-weight: bold;">.</span><span style="color: black;">WriteRecord</span><span style="color: black; font-weight: bold;">((</span><span style="color: #204a87; font-weight: bold;">char</span><span style="color: #ce5c00; font-weight: bold;">*</span><span style="color: black; font-weight: bold;">)</span><span style="color: black;">pData3</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">MAX_DATA_SIZE</span><span style="color: black; font-weight: bold;">))</span> <span style="color: black; font-weight: bold;">{</span><br />        <span style="color: #204a87; font-weight: bold;">return</span> <span style="color: #204a87;">false</span><span style="color: black; font-weight: bold;">;</span><br />    <span style="color: black; font-weight: bold;">}</span><br /><br />    <span style="color: #204a87; font-weight: bold;">return</span> <span style="color: #204a87;">true</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: black; font-weight: bold;">}</span> <br /><br /><span style="color: #8f5902; font-style: italic;">//그리고 실제 호출시에는 다음처럼 strData3에 불필요한(?) 복사를 생략하여,&nbsp;</span></pre><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902; font-style: italic;">//값을 채우지 않는다.</span><br /><span style="color: black;">ItemFileBlock</span> <span style="color: black;">stFileBlock</span><span style="color: black; font-weight: bold;">;</span><br /><span style="color: #8f5902; font-style: italic;">//stFileBlock 의 항목을 채운다. </span><br /><span style="color: black; font-weight: bold;">.....</span><br /><span style="color: black; font-weight: bold;">.....</span><br /><span style="color: #8f5902; font-style: italic;">//memcpy(&amp;stFileBlock.strData3, 사용자의정보, MAX_DATA_SIZE); //생략!</span><br /><br /><span style="color: #8f5902; font-style: italic;">//함수 호출</span><br /><span style="color: #204a87; font-weight: bold;">if</span><span style="color: black; font-weight: bold;">(</span><span style="color: #ce5c00; font-weight: bold;">!</span><span style="color: black;">SaveDataToFile</span><span style="color: black; font-weight: bold;">(</span><span style="color: #ce5c00; font-weight: bold;">&amp;</span><span style="color: black;">stFileBlock</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">pData3</span><span style="color: black; font-weight: bold;">)){</span><br />    <span style="color: black; font-weight: bold;">....</span><br /><span style="color: black; font-weight: bold;">}</span><br /></pre></div><br /><br /><br /><div class="sunburst" style="line-height: 1.3em; margin-top: 0em;"><span style="background-color: yellow;"><b><span style="font-size: small;"><span style="font-family: inherit;"><span class="meta meta_function meta_function_c"><span class="meta meta_function-call meta_function-call_c"><span class="support support_function support_function_any-method support_function_any-method_c" style="color: #cc0000;">sizeof</span>(</span>ItemFileBlock)-MAX_DATA_SIZE</span></span></span></b></span></div><b><span style="font-size: small;"><span style="font-family: inherit;"><span style="color: #0b5394;"><span style="color: black;"> </span></span></span></span> <span style="font-size: small;"><span style="font-family: inherit;"><span style="color: #0b5394;"><span style="color: black;">&nbsp;</span></span></span></span></b><br /><b><span style="font-size: small;"><span style="font-family: inherit;"><span style="color: #0b5394;"><span style="color: black;">구조체 크기에서 MAX_DATA_SIZE 만큼 빼면 strData3 항목의 시작위치가 될것이라는 <span style="font-family: inherit;">가정</span>..</span></span></span></span></b><br /><span style="color: #0b5394; font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><span style="color: black;"><br /></span></span></span> <span style="color: #0b5394;"><span style="color: black; font-family: inherit;">이렇게 구조체의 선언만 보고, 임의로 구조체 크기를 가정하고 거기에 offset연산까지 적용해서 어떤 구조체 멤버에 접근하려는 시도가 문제되는 부분이다. 원래 작성자의 의도는 구조체의 strData3 이전 데이터를 먼저 파일로 저장후, 이어서 실제 사용자 데이터 부분을 저장하려던 것이었다. 불필요한 복사를 생략하고, 이미 구해진 데이터의 포인터를 활용해보자는 목적이었는데, 문제는 sizeof(ItemFileBlock) 이 돌려주는 길이는 컴파일러에 의해 암묵적으로 삽입된 패딩 바이트를 포함하고 있다는 것이다.</span></span><br /><span style="font-family: inherit;"><br />offsetof 매크로를 이용, 각 구조체 멤버의 offset 위치를 구해보자.&nbsp;</span><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.4em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #8f5902; font-style: italic;">#define MAX_DATA_SIZE  2048</span><br /><span style="color: #204a87; font-weight: bold;">typedef</span> <span style="color: #204a87; font-weight: bold;">struct</span> <span style="color: black;">__FileBlock</span><br /><span style="color: black; font-weight: bold;">{</span><br />    <span style="color: #204a87; font-weight: bold;">char</span>     <span style="color: black;">strData1</span> <span style="color: black; font-weight: bold;">[</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: black; font-weight: bold;">];</span><br />    <span style="color: #204a87; font-weight: bold;">int</span>      <span style="color: black;">nNumber1</span>  <span style="color: black; font-weight: bold;">;</span> <span style="color: #8f5902; font-style: italic;">//4byte</span><br />    <span style="color: #204a87; font-weight: bold;">int</span>      <span style="color: black;">nNumber2</span>  <span style="color: black; font-weight: bold;">;</span> <span style="color: #8f5902; font-style: italic;">//4byte</span><br />    <span style="color: #204a87; font-weight: bold;">int</span>      <span style="color: black;">nNumber3</span>  <span style="color: black; font-weight: bold;">;</span> <span style="color: #8f5902; font-style: italic;">//4byte</span><br />    <span style="color: #204a87; font-weight: bold;">char</span>     <span style="color: black;">strData2</span> <span style="color: black; font-weight: bold;">[</span><span style="color: #0000cf; font-weight: bold;">50</span><span style="color: black; font-weight: bold;">];</span><br />    <span style="color: #204a87; font-weight: bold;">char</span>     <span style="color: black;">strData3</span> <span style="color: black; font-weight: bold;">[</span><span style="color: black;">MAX_DATA_SIZE</span><span style="color: black; font-weight: bold;">];</span><br /><span style="color: black; font-weight: bold;">}</span> <span style="color: black;">ItemFileBlock</span><span style="color: black; font-weight: bold;">;</span><br /><br /><span style="color: #204a87; font-weight: bold;">void</span> <span style="color: black;">testFunc</span><span style="color: black; font-weight: bold;">()</span><br /><span style="color: black; font-weight: bold;">{</span><br />    <span style="color: black;">printf</span><span style="color: black; font-weight: bold;">(</span><span style="color: #4e9a06;">"sizeof(ItemFileBlock)[%d]\n"</span><span style="color: black; font-weight: bold;">,</span><span style="color: #204a87; font-weight: bold;">sizeof</span><span style="color: black; font-weight: bold;">(</span><span style="color: black;">ItemFileBlock</span><span style="color: black; font-weight: bold;">));</span><br />    <span style="color: black;">printf</span><span style="color: black; font-weight: bold;">(</span> <span style="color: #4e9a06;">"offsetof(strData1)  =%d\n"</span><span style="color: black; font-weight: bold;">,</span><span style="color: black;">offsetof</span><span style="color: black; font-weight: bold;">(</span><span style="color: #204a87; font-weight: bold;">struct</span> <span style="color: black;">__FileBlock</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">strData1</span> <span style="color: black; font-weight: bold;">));</span><br />    <span style="color: black;">printf</span><span style="color: black; font-weight: bold;">(</span> <span style="color: #4e9a06;">"offsetof(nNumber1)  =%d\n"</span><span style="color: black; font-weight: bold;">,</span><span style="color: black;">offsetof</span><span style="color: black; font-weight: bold;">(</span><span style="color: #204a87; font-weight: bold;">struct</span> <span style="color: black;">__FileBlock</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">nNumber1</span> <span style="color: black; font-weight: bold;">));</span><br />    <span style="color: black;">printf</span><span style="color: black; font-weight: bold;">(</span> <span style="color: #4e9a06;">"offsetof(nNumber2)  =%d\n"</span><span style="color: black; font-weight: bold;">,</span><span style="color: black;">offsetof</span><span style="color: black; font-weight: bold;">(</span><span style="color: #204a87; font-weight: bold;">struct</span> <span style="color: black;">__FileBlock</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">nNumber2</span> <span style="color: black; font-weight: bold;">));</span><br />    <span style="color: black;">printf</span><span style="color: black; font-weight: bold;">(</span> <span style="color: #4e9a06;">"offsetof(nNumber3)  =%d\n"</span><span style="color: black; font-weight: bold;">,</span><span style="color: black;">offsetof</span><span style="color: black; font-weight: bold;">(</span><span style="color: #204a87; font-weight: bold;">struct</span> <span style="color: black;">__FileBlock</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">nNumber3</span> <span style="color: black; font-weight: bold;">));</span><br />    <span style="color: black;">printf</span><span style="color: black; font-weight: bold;">(</span> <span style="color: #4e9a06;">"offsetof(strData2)  =%d\n"</span><span style="color: black; font-weight: bold;">,</span><span style="color: black;">offsetof</span><span style="color: black; font-weight: bold;">(</span><span style="color: #204a87; font-weight: bold;">struct</span> <span style="color: black;">__FileBlock</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">strData2</span> <span style="color: black; font-weight: bold;">));</span><br />    <span style="color: black;">printf</span><span style="color: black; font-weight: bold;">(</span> <span style="color: #4e9a06;">"offsetof(strData3)  =%d\n"</span><span style="color: black; font-weight: bold;">,</span><span style="color: black;">offsetof</span><span style="color: black; font-weight: bold;">(</span><span style="color: #204a87; font-weight: bold;">struct</span> <span style="color: black;">__FileBlock</span><span style="color: black; font-weight: bold;">,</span> <span style="color: black;">strData3</span> <span style="color: black; font-weight: bold;">));</span><br /><span style="color: black; font-weight: bold;">}</span><br /><br /><span style="color: #8f5902; font-style: italic;">//실행 결과</span><br /><span style="color: #204a87; font-weight: bold;">sizeof</span><span style="color: black; font-weight: bold;">(</span><span style="color: black;">ItemFileBlock</span><span style="color: black; font-weight: bold;">)[</span><span style="color: #0000cf; font-weight: bold;">2116</span><span style="color: black; font-weight: bold;">]</span><br /><span style="color: black;">offsetof</span><span style="color: black; font-weight: bold;">(</span><span style="color: black;">__FileBlock</span><span style="color: black; font-weight: bold;">,</span><span style="color: black;">strData1</span><span style="color: black; font-weight: bold;">)</span>  <span style="color: #ce5c00; font-weight: bold;">=</span><span style="color: #0000cf; font-weight: bold;">0</span><br /><span style="color: black;">offsetof</span><span style="color: black; font-weight: bold;">(</span><span style="color: black;">__FileBlock</span><span style="color: black; font-weight: bold;">,</span><span style="color: black;">nNumber1</span><span style="color: black; font-weight: bold;">)</span>  <span style="color: #ce5c00; font-weight: bold;">=</span><span style="color: #0000cf; font-weight: bold;">4</span><br /><span style="color: black;">offsetof</span><span style="color: black; font-weight: bold;">(</span><span style="color: black;">__FileBlock</span><span style="color: black; font-weight: bold;">,</span><span style="color: black;">nNumber2</span><span style="color: black; font-weight: bold;">)</span>  <span style="color: #ce5c00; font-weight: bold;">=</span><span style="color: #0000cf; font-weight: bold;">8</span><br /><span style="color: black;">offsetof</span><span style="color: black; font-weight: bold;">(</span><span style="color: black;">__FileBlock</span><span style="color: black; font-weight: bold;">,</span><span style="color: black;">nNumber3</span><span style="color: black; font-weight: bold;">)</span>  <span style="color: #ce5c00; font-weight: bold;">=</span><span style="color: #0000cf; font-weight: bold;">12</span><br /><span style="color: black;">offsetof</span><span style="color: black; font-weight: bold;">(</span><span style="color: black;">__FileBlock</span><span style="color: black; font-weight: bold;">,</span><span style="color: black;">strData2</span><span style="color: black; font-weight: bold;">)</span>  <span style="color: #ce5c00; font-weight: bold;">=</span><span style="color: #0000cf; font-weight: bold;">16</span><br /><span style="color: black;">offsetof</span><span style="color: black; font-weight: bold;">(</span><span style="color: black;">__FileBlock</span><span style="color: black; font-weight: bold;">,</span><span style="color: black;">strData3</span><span style="color: black; font-weight: bold;">)</span>  <span style="color: #ce5c00; font-weight: bold;">=</span><span style="color: #0000cf; font-weight: bold;">66</span><br /></pre></div><br /><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">즉 다음처럼 패딩 바이트가 삽입됨을 알수있다.</span><br /><!-- HTML generated using hilite.me --><br /><div style="background: #f8f8f8; border-width: 0.1em 0.1em 0.1em 0.4em; border: solid gray; overflow: auto; padding: 0.2em 0.6em; width: auto;"><pre style="line-height: 125%; margin: 0;"><span style="color: #204a87; font-weight: bold;">typedef</span> <span style="color: #204a87; font-weight: bold;">struct</span> <span style="color: black;">__FileBlock</span><br /><span style="color: black; font-weight: bold;">{</span><br />    <span style="color: #204a87; font-weight: bold;">char</span>     <span style="color: black;">strData1</span> <span style="color: black; font-weight: bold;">[</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: black; font-weight: bold;">];</span> <span style="color: #8f5902; font-style: italic;">//offset 0</span><br />    <span style="color: #204a87; font-weight: bold;">char</span>     <span style="color: black;">padding</span>  <span style="color: black; font-weight: bold;">[</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: black; font-weight: bold;">];</span> <span style="color: #8f5902; font-style: italic;">//offset 2 </span><br />    <span style="color: #204a87; font-weight: bold;">int</span>      <span style="color: black;">nNumber1</span>  <span style="color: black; font-weight: bold;">;</span>   <span style="color: #8f5902; font-style: italic;">//offset 4     </span><br />    <span style="color: #204a87; font-weight: bold;">int</span>      <span style="color: black;">nNumber2</span>  <span style="color: black; font-weight: bold;">;</span>   <span style="color: #8f5902; font-style: italic;">//offset 8    </span><br />    <span style="color: #204a87; font-weight: bold;">int</span>      <span style="color: black;">nNumber3</span>  <span style="color: black; font-weight: bold;">;</span>   <span style="color: #8f5902; font-style: italic;">//offset 12    </span><br />    <span style="color: #204a87; font-weight: bold;">char</span>     <span style="color: black;">strData2</span> <span style="color: black; font-weight: bold;">[</span><span style="color: #0000cf; font-weight: bold;">50</span><span style="color: black; font-weight: bold;">];</span><span style="color: #8f5902; font-style: italic;">//offset 16    </span><br />    <span style="color: #204a87; font-weight: bold;">char</span>     <span style="color: black;">strData3</span> <span style="color: black; font-weight: bold;">[</span><span style="color: black;">MAX_DATA_SIZE</span><span style="color: black; font-weight: bold;">];</span> <span style="color: #8f5902; font-style: italic;">//offset 66</span><br />    <span style="color: #204a87; font-weight: bold;">char</span>     <span style="color: black;">padding</span>  <span style="color: black; font-weight: bold;">[</span><span style="color: #0000cf; font-weight: bold;">2</span><span style="color: black; font-weight: bold;">];</span> <span style="color: #8f5902; font-style: italic;">//offset 2114</span><br /><span style="color: black; font-weight: bold;">}</span> <span style="color: black;">ItemFileBlock</span><span style="color: black; font-weight: bold;">;</span><br /></pre></div><br /><br /><div><div style="line-height: normal; white-space: normal;"><div style="background-color: white; line-height: 1.3em; margin-top: 0em;"><span style="font-family: inherit; line-height: 1.3em;">sizeof(ItemFileBlock)&nbsp;는 모든 구조체 멤버의 실제 길이를 합한 길이 2112 가 아니고,&nbsp;</span></div><div style="background-color: white; line-height: 1.3em; margin-top: 0em;"><span style="font-family: inherit; line-height: 1.3em;">컴파일러에 의해 삽입된 패딩 바이트를 포함한 2116을 리턴한다.</span></div><div style="background-color: white; line-height: 1.3em; margin-top: 0em;"><span style="font-family: inherit;"><span style="color: #0b5394;"><span style="color: black;">그래서 </span></span>sizeof(ItemFileBlock)&nbsp; - MAX_DATA_SIZE&nbsp;이값은 2116-2048 = 68이 되버린다.</span><span style="font-family: inherit;"></span><br /><span style="font-family: inherit;"><br /></span></div><div style="background-color: white; line-height: 1.3em; margin-top: 0em;"><span style="font-family: inherit;">이것이 왜 문제가 되는가?</span><span style="font-family: inherit;">&nbsp;</span><br /><span style="font-family: inherit;">위 파일 저장 함수에서 2번에 걸쳐 저장을 할때, 처음 쓰기에서는 68 바이트를 저장하고있다.</span><span style="font-family: inherit;"> 이렇게 되면 실제 저장되어야할 길이 66 바이트보다 2 바이트를 초과해서 쓴 꼴이 된다.</span><span style="font-family: inherit;"> 그리고 2번째 파일 쓰기에서는 2바이트가 밀린 상태로 나머지 strData3을 쓰게 된다. <span style="color: #0b5394;"><span style="color: black;">이런식으로 2번에 걸쳐 파일에 저장시, 실제 파일에 저장되는 구조체의 데이터는, 구조체를 한번에 저장할때와 다른 모습으로 비정상으로 저장된다.&nbsp;</span></span></span></div><div style="background-color: white; line-height: 1.3em; margin-top: 0em;"><span style="font-family: inherit;"><span style="color: #0b5394;"><span style="color: black;"><br /></span></span></span><span style="color: #45818e; font-family: inherit;"><b>&nbsp;</b></span><br /><span style="color: #45818e; font-family: inherit;"><b>* 정상적으로 구조체가 저장된 경우</b>&nbsp;</span></div><div style="background-color: white; line-height: 1.3em; margin-top: 0em;"><span style="color: #45818e; font-family: inherit;"><br /></span><span style="color: #45818e; font-family: inherit;">|---------strData1~2----|---------------strData3--------------|---padding----|</span><br /><span style="color: #45818e; font-family: inherit;">&nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; 66 bytes &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;&nbsp; &nbsp; &nbsp;&nbsp; 2048 bytes &nbsp;&nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 2 bytes</span><span style="color: #45818e; font-family: inherit;"><b><br /></b></span></div><div style="background-color: white; line-height: 1.3em; margin-top: 0em;"><span style="color: #45818e; font-family: inherit;"><b>* 비정상적으로 구조체가 저장된 경우</b>&nbsp;</span><span style="font-family: inherit;"><span style="color: #45818e;"><br /></span></span></div><div style="background-color: white; line-height: 1.3em; margin-top: 0em;"><span style="font-family: inherit;"><span style="color: #45818e;">|---------strData1~2--------------------|</span><span style="color: #45818e;">---------------strData3-------------</span><span style="color: #45818e;">|</span></span><span style="font-family: inherit;"><span style="color: #45818e;">&nbsp;</span></span><br /><span style="font-family: inherit;"><span style="color: #45818e;">&nbsp;&nbsp; &nbsp;&nbsp;</span><span style="color: #45818e;">&nbsp;&nbsp;&nbsp;&nbsp; 68 bytes</span><span style="color: #45818e;">&nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; 2048 bytes</span></span><span style="font-family: inherit;"><br /></span></div><div style="background-color: white; line-height: 1.3em; margin-top: 0em;"><br /><span style="font-family: inherit;">이처럼 잘못 저장된 데이터를 다시 파일에서 읽어들이는 경우는 어떨까?</span><span style="font-family: inherit;">&nbsp;</span><br /><span style="font-family: inherit;">파일에서 읽어 이를 구조체로 변경하는 경우, strData3 데이터 시작부분이 2 byte가 밀려 있으리란것을 예상할수 있다</span><span style="font-family: inherit;"> (실제로 당하니 멘붕. 데이터를 분명 썼는데 읽으면 안보임 - -).&nbsp;</span><span style="font-family: inherit;"> 이것을 해결하기 위해서는 구조체 pack 혹은 명시적으로 패딩 바이트를 삽입하는 방법등이 있는데 그것은 생략한다.</span><span style="font-family: inherit;"> 구조체는 일반적인 방법(멤버 참조)으로 쓰는 경우는 문제 없다. 하지만 위에서처럼 offset 으로 멤버의 위치를 유추하려는 시도를 할때는 반드시 암묵적 패딩 바이트를 고려해야만 한다.</span></div></div></div><span style="color: #0b5394; font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;"><span style="color: black;">&nbsp;</span></span><b><span style="font-family: &quot;arial&quot; , &quot;helvetica&quot; , sans-serif;">&nbsp; </span></b></span>